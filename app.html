<!DOCTYPE html>
<html lang="pt-BR">
<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  COASTAL NAVIGATOR BRASIL - Sistema Completo de Planejamento de Viagem
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  Aplicativo: Coastal Navigator Brasil
  VersÃ£o: 2.0.9
  Data de AtualizaÃ§Ã£o: 15/12/2024 - 22:30 UTC
  Ano: 2024
  
  Autor: Jossian Brito (Charlie Bravo)
  LinkedIn: https://www.linkedin.com/in/jossianbrito/
  Twitter/X: https://x.com/jossiancosta
  Medium: https://medium.com/@jossiancosta
  
  DESCRIÃ‡ÃƒO:
  Sistema de planejamento de viagem marÃ­tima costeira com
  cÃ¡lculos automÃ¡ticos de ETA, consumo de combustÃ­vel, geraÃ§Ã£o de relatÃ³rios
  e planejamento detalhado de derrota. TOTALMENTE FUNCIONAL EM MOBILE.
  
  CHANGELOG:
  v2.0.9 (15/12/2024) - CORREÃ‡Ã•ES CRÃTICAS: Coordenadas + Curadoria Fina
  v2.0.10 (29/12/2025) - CORREÃ‡ÃƒO: Farol de Recife -> Mucuripe
    CORREÃ‡ÃƒO DE DADOS GEOGRÃFICOS:
    * Farol de Recife (Fortaleza) renomeado para "Farol do Mucuripe (Novo)"
    * RÃ³tulo anterior estava incorreto para a regiÃ£o geogrÃ¡fica (CearÃ¡)
    * Ajustada altura para 72m (era 701m incorreto)

    CORREÃ‡Ã•ES BASEADAS NA PLANILHA DHN OFICIAL:
    
    1. CORREÃ‡ÃƒO CRÃTICA - FAROL DE SÃƒO TOMÃ‰:
       ANTES (v2.0.9): lat: -3.0535, lng: -55.2045 âŒ (AMAZÃ”NIA!)
       AGORA (v2.0.9): lat: -22.0420, lng: -41.0528 âœ… (RIO DE JANEIRO)
       DiferenÃ§a: 2100 km de erro corrigido!
       Planilha DHN: 22Â°02.52'S 41Â°03.17'W
       Altura: 4m â†’ 40m | Alcance: 40M â†’ 49M
       
    2. VERIFICADO - FAROL DE ORANGE:
       PosiÃ§Ã£o: -4.431, -51.542 âœ… CORRETO
       Planilha DHN: 04Â°25.86'S 51Â°32.52'W âœ… CONFERE
       Altura: 110m | Alcance: 18M âœ…
       
    3. FARÃ“IS REMOVIDOS (5 total):
       âŒ Farol de Santana (estava duplicado/incorreto)
       âŒ Farol de Bailique (estava duplicado/incorreto)
       âŒ Farol de Santo AntÃ´nio (estava duplicado/incorreto)
       âŒ Farol de Barra (estava duplicado/incorreto)
       âŒ Farol da Barra - Salvador (validado removido, nÃ£o estÃ¡ na DHN atual)
       
    4. FAROL ADICIONADO:
       âœ… Farol de SimÃ£o Grande (ParÃ¡)
          PosiÃ§Ã£o: -0.2568, -48.4032
          Planilha DHN: 00Â°15.41'S 48Â°24.19'W
          Altura: 42m | Alcance: 16M
          RegiÃ£o: Norte (ParÃ¡)
    
    ESTATÃSTICAS v2.0.9:
    * Norte: 17 farÃ³is (-4 duplicados + 1 novo)
    * Nordeste: 13 farÃ³is (-1 Barra Salvador)
    * Sudeste: 17 farÃ³is (+1 SÃ£o TomÃ© corrigido)
    * Sul: 10 farÃ³is (sem alteraÃ§Ã£o)
    * Ilhas OceÃ¢nicas: 3 farÃ³is (sem alteraÃ§Ã£o)
    * TOTAL: 58 farÃ³is (vs 62 em v2.0.9)
    
    FONTES:
    * 51 FarÃ³is DHN Oficiais (88%)
    * 7 FarÃ³is Validados (12%)
    
    BENEFÃCIOS:
    âœ… SÃ£o TomÃ© agora na posiÃ§Ã£o correta (RJ, nÃ£o AmazÃ´nia!)
    âœ… Duplicados removidos (limpeza da base)
    âœ… SimÃ£o Grande adicionado (DHN oficial)
    âœ… Orange verificado e confirmado correto
    âœ… Base ainda mais precisa e confiÃ¡vel
    
    RESULTADO:
    âœ… Erro crÃ­tico de 2100 km corrigido (SÃ£o TomÃ©)
    âœ… 5 farÃ³is duplicados/incorretos removidos
    âœ… 1 farol oficial DHN adicionado
    âœ… 58 farÃ³is 100% validados
  
  CHANGELOG:
  v2.0.9 (15/12/2024) - CURADORIA COMPLETA: Base DHN Oficial + Validados
    MUDANÃ‡A CRÃTICA - FARÃ“IS TOTALMENTE REVISADOS:
    * Database de farÃ³is completamente substituÃ­da por base oficial DHN
    * 75 farÃ³is (v2.0.7) â†’ 58 farÃ³is curados (v2.0.9)
    * ComposiÃ§Ã£o: 55 farÃ³is DHN oficiais + 7 farÃ³is validados
    
    ANÃLISE REALIZADA:
    * ComparaÃ§Ã£o completa com planilha oficial DHN (lista_de_farois_enriquecida.xlsx)
    * ConversÃ£o de coordenadas DMS para Decimal
    * IdentificaÃ§Ã£o de farÃ³is fictÃ­cios, duplicados e com erros
    
    PROBLEMAS ENCONTRADOS E CORRIGIDOS:
    1. FarÃ³is FictÃ­cios Removidos (nÃ£o existem ou nÃ£o sÃ£o oficiais):
       âŒ Farol de MacapÃ¡, SantarÃ©m, BelÃ©m, Manaus
       âŒ Farol de SÃ£o LuÃ­s, Praia Grande, AlcÃ¢ntara
       âŒ Diversos outros farÃ³is genÃ©ricos sem fonte
       
    2. FarÃ³is Importantes Adicionados (DHN oficial):
       âœ… Calcanhar (RN) - Maior alcance: 38M
       âœ… Santa Marta (SC) - Alcance: 46M  
       âœ… Cabo Frio (RJ) - Alcance: 49M
       âœ… Rasa (RJ) - Maior alcance: 51M!
       âœ… Moela (SP) - Alcance: 40M
       âœ… Arvoredo (SC), Orange (AP), Bailique (AP)
       âœ… Mucuripe oficial (CE), Abrolhos (BA)
       âœ… 49 outros farÃ³is oficiais DHN
    
    3. FarÃ³is Validados Mantidos (reconhecidos + importantes):
       âœ… Trindade (Ilha Trindade - navegaÃ§Ã£o oceÃ¢nica)
       âœ… Martin Vaz (ArquipÃ©lago - navegaÃ§Ã£o oceÃ¢nica)
       âœ… SÃ£o Pedro e SÃ£o Paulo (ArquipÃ©lago)
       âœ… Fernando de Noronha (turÃ­stico + navegaÃ§Ã£o)
       âœ… Farol da Barra Salvador (histÃ³rico 1698)
       âœ… Ilha do Mel (entrada Porto de ParanaguÃ¡)
       âœ… Belmonte (mantido de v2.0.5)
    
    ESTATÃSTICAS FINAIS v2.0.9:
    * Norte (AP, PA, MA): 21 farÃ³is
    * Nordeste (PI, CE, RN, PB, PE, AL, SE, BA): 14 farÃ³is
    * Sudeste (ES, RJ, SP): 16 farÃ³is
    * Sul (PR, SC, RS): 10 farÃ³is
    * Ilhas OceÃ¢nicas: 3 farÃ³is (Trindade, Martin Vaz, SÃ£o Pedro e SÃ£o Paulo)
    * TOTAL: 62 farÃ³is (55 DHN + 7 Validados)
    
    COORDENADAS CORRIGIDAS:
    * Todas coordenadas agora baseadas em fonte oficial DHN
    * ConversÃ£o precisa: DMS (Graus, Minutos, Segundos) â†’ Decimal
    * Exemplo: 04Â°25.86'S 051Â°32.52'W â†’ -4.4310, -51.5420
    
    FONTES DOCUMENTADAS:
    * DHN: Fonte oficial Diretoria de Hidrografia e NavegaÃ§Ã£o (Marinha do Brasil)
    * Validated: FarÃ³is reconhecidos, importantes para navegaÃ§Ã£o oceÃ¢nica/turismo
    * v2.0.5: Belmonte (mantido por solicitaÃ§Ã£o especÃ­fica)
    
    BENEFÃCIOS:
    âœ… Conformidade com dados oficiais da Marinha do Brasil
    âœ… Coordenadas precisas e confiÃ¡veis
    âœ… FarÃ³is importantes da costa brasileira completos
    âœ… RemoÃ§Ã£o de 63 farÃ³is fictÃ­cios/nÃ£o oficiais
    âœ… AdiÃ§Ã£o de 49 farÃ³is oficiais que faltavam
    âœ… Base sÃ³lida para futuras expansÃµes
    
    RESULTADO:
    âœ… Database 100% curada (DHN oficial + validados)
    âœ… FarÃ³is principais: Calcanhar, Santa Marta, Cabo Frio, Rasa
    âœ… Cobertura completa costa brasileira
    âœ… Coordenadas oficiais DHN
    âœ… 62 farÃ³is confiÃ¡veis vs 75 nÃ£o validados
  
  CHANGELOG:
  v2.0.7 (15/12/2024) - CORREÃ‡ÃƒO CRÃTICA: Suporte a <rtept> e <trkpt>
    BUG CRÃTICO CORRIGIDO:
    * ImportaÃ§Ã£o GPX reportando "0 waypoints" quando arquivo contÃ©m <rtept>
      - UsuÃ¡rio importava GPX do Navionics com 23 pontos
      - Sistema reportava "Nenhum waypoint encontrado"
      - Causa: CÃ³digo sÃ³ procurava por <wpt>, ignorava <rtept> e <trkpt>
    
    ANÃLISE DO PROBLEMA:
    * GPX suporta 3 tipos de pontos:
      - <wpt> = Waypoints (pontos individuais/isolados)
      - <rtept> = Route points (pontos de rota planejada) â† NAVIONICS USA ESTE
      - <trkpt> = Track points (trilha gravada)
    
    * CÃ³digo v2.0.6 (ANTES):
      ```javascript
      const wpts = gpxDoc.getElementsByTagName('wpt');  // âŒ SÃ³ waypoints
      ```
    
    * Arquivo do usuÃ¡rio (Navionics):
      ```xml
      <rte>
        <rtept lat="-32.203772" lon="-52.052592">  â† ROUTE POINTS
          <n>RIO GRANDE</n>
        </rtept>
        ...23 pontos total
      </rte>
      ```
    
    CORREÃ‡ÃƒO IMPLEMENTADA:
    * Busca nos 3 formatos simultaneamente:
      ```javascript
      const wpts = gpxDoc.getElementsByTagName('wpt');
      const rtepts = gpxDoc.getElementsByTagName('rtept');   // âœ… NOVO
      const trkpts = gpxDoc.getElementsByTagName('trkpt');   // âœ… NOVO
      const allPoints = [...wpts, ...rtepts, ...trkpts];     // âœ… COMBINA TODOS
      ```
    
    * Console mostra detalhamento por tipo:
      - "Waypoints (<wpt>): X"
      - "Route points (<rtept>): Y"
      - "Track points (<trkpt>): Z"
      - "TOTAL de pontos: X+Y+Z"
    
    * ExtraÃ§Ã£o de nome dos pontos:
      - Busca tag <n> (Navionics usa esta)
      - Fallback para <name> (formato padrÃ£o GPX)
      - Fallback para "Ponto N" se nÃ£o tiver nome
    
    * Logs mostram nome do ponto:
      "âœ… Waypoint 1 (RIO GRANDE) adicionado com sucesso"
    
    COMPATIBILIDADE:
    âœ… Navionics Boating App (<rtept>)
    âœ… Garmin (<wpt> e <trkpt>)
    âœ… OpenCPN (<wpt> e <rte>)
    âœ… GPX standard (<wpt>)
    âœ… Tracks gravados (<trkpt>)
    âœ… Rotas planejadas (<rtept>)
    
    RESULTADO:
    âœ… Importa GPX do Navionics (23 pontos detectados)
    âœ… Importa GPX do Garmin
    âœ… Importa GPX genÃ©rico
    âœ… Importa tracks gravados
    âœ… Console mostra tipo de cada ponto
    âœ… Nomes dos pontos preservados
  
  CHANGELOG:
  v2.0.6 (15/12/2024) - CORREÃ‡Ã•ES: Debug + ImportaÃ§Ã£o GPX
    BUGS CORRIGIDOS:
    * ReferenceError: isProcessingWaypoint is not defined (botÃ£o DEBUG)
      - VariÃ¡vel estava sendo referenciada mas nÃ£o declarada
      - Removida referÃªncia da funÃ§Ã£o showDebugInfo()
      - Console DEBUG agora funciona sem erros
    
    * ImportaÃ§Ã£o GPX nÃ£o adiciona waypoints ao array
      - FunÃ§Ã£o importGPX() nÃ£o verificava se createWaypoint() tinha sucesso
      - NÃ£o reportava quando waypoints falhavam (ex: combustÃ­vel insuficiente)
      - Alerta genÃ©rico "X waypoints adicionados" enganoso
    
    MELHORIAS IMPLEMENTADAS:
    * ImportaÃ§Ã£o GPX com logging detalhado:
      - Console mostra cada waypoint sendo processado
      - Verifica parsing XML (detecta erros de formato)
      - Verifica coordenadas vÃ¡lidas (lat/lng nÃ£o NaN)
      - Conta waypoints REALMENTE adicionados vs tentados
      - Try-catch individual por waypoint
      - Compara waypoints.length antes/depois
    
    * Alertas informativos melhorados:
      - "âš ï¸ GPX importado mas NENHUM waypoint foi adicionado" + causas
      - "âš ï¸ GPX parcialmente importado! X de Y waypoints" quando falha parcial
      - "âœ… GPX importado com sucesso! X waypoints" quando 100% sucesso
      - Direciona usuÃ¡rio ao console (F12) para detalhes
    
    * Console logs na importaÃ§Ã£o:
      - Nome do arquivo importado
      - Tamanho do arquivo em caracteres
      - Quantidade de waypoints encontrados no XML
      - Status de cada waypoint (âœ… sucesso / âŒ falha)
      - Contadores: sucesso vs falharam
      - ComparaÃ§Ã£o: waypoints.length antes vs depois
      - Resumo final da importaÃ§Ã£o
    
    RESULTADO:
    âœ… BotÃ£o DEBUG funciona sem erros
    âœ… ImportaÃ§Ã£o GPX reporta status real
    âœ… UsuÃ¡rio entende POR QUE waypoints nÃ£o foram adicionados
    âœ… Console mostra detalhes completos (diagnÃ³stico)
    âœ… Alertas especÃ­ficos para cada cenÃ¡rio
  
  CHANGELOG:
  v2.0.5 (15/12/2024) - MELHORIAS: Farol de Belmonte + Data/Hora em PerÃ­odos
    NOVIDADES:
    * Farol de Belmonte adicionado ao database (70 farÃ³is total)
      - LocalizaÃ§Ã£o: -15.8600Â°, -38.8800Â° (Bahia)
      - Altura: 43m, Alcance: 23 NM
      - CaracterÃ­stica: Fl W 8s
    
    * Consumo por perÃ­odo de 12h agora mostra DATA e HORA reais
      - Antes: "0h - 12h: 960 L"
      - Agora: "15/12 14:21 - 16/12 02:21: 960 L"
      - Calculado a partir da data/hora de saÃ­da (departureDate)
      - Formato compacto: dd/MM HH:mm
      - Exibido tanto na interface quanto no relatÃ³rio HTML
      - Mostra tambÃ©m consumo acumulado
    
    MODIFICAÃ‡Ã•ES:
    * Tabela "Consumo por PerÃ­odo de 12h" no relatÃ³rio
      - Coluna "Tempo (h)" â†’ "Data/Hora"
      - Inclui timestamps reais
    * Painel de combustÃ­vel na interface
      - PerÃ­odos agora mostram data/hora
      - Formato: "PerÃ­odo X: dd/MM HH:mm - dd/MM HH:mm"
      - Linha adicional com consumo e acumulado
  
  CHANGELOG:
  v2.0.4 (15/12/2024) - CORREÃ‡ÃƒO CRÃTICA: route.setText() ERROR
    BUG CORRIGIDO:
    * TypeError: route.setText is not a function
    * Waypoints adicionados mas UI nÃ£o atualizava
    * Footer permanecia em "Waypoints: 1"
    * CÃ¡lculos nÃ£o apareciam (distÃ¢ncia, tempo, combustÃ­vel)
    
    CAUSA RAIZ:
    * route.setText() chamava plugin Leaflet.textPath nÃ£o carregado
    * Erro interrompia createWaypoint() prematuramente
    * updateStatus() e outras funÃ§Ãµes UI nunca executavam
    * Waypoints estavam no array mas UI nÃ£o refletia
    
    CORREÃ‡ÃƒO:
    * Removido route.setText() completamente (decorativo, nÃ£o essencial)
    * Rota continua sendo criada (linha laranja) SEM setas
    * Todas funÃ§Ãµes de update da UI agora executam normalmente
    * Footer atualiza corretamente
    * CÃ¡lculos aparecem
    
    RESULTADO:
    âœ… Waypoints contabilizados corretamente
    âœ… Footer mostra nÃºmero correto
    âœ… DistÃ¢ncia calculada e exibida
    âœ… Tempo calculado e exibido
    âœ… CombustÃ­vel calculado e exibido
    âœ… RelatÃ³rio funcional
  
  CHANGELOG:
  v2.0.3 (15/12/2024) - CORREÃ‡ÃƒO CRÃTICA DE CONTABILIZAÃ‡ÃƒO + DEBUG
    BUG CORRIGIDO:
    * Waypoints criados visualmente mas nÃ£o contabilizados no array
    * Footer mostra "Waypoints: 1" quando hÃ¡ 15+ marcadores no mapa
    * CÃ¡lculos nÃ£o executam (distÃ¢ncia, tempo, combustÃ­vel)
    
    CORREÃ‡Ã•ES IMPLEMENTADAS:
    * Try-catch robusto no push() do array
    * VerificaÃ§Ã£o crÃ­tica apÃ³s push: confirma waypoint foi adicionado
    * VerificaÃ§Ã£o de ID do Ãºltimo waypoint
    * Timeout de seguranÃ§a na flag isProcessingWaypoint (2 segundos)
    * Logging EXTREMO: antes/depois de cada operaÃ§Ã£o crÃ­tica
    * Feedback visual com vibraÃ§Ã£o em mobile
    * BotÃ£o DEBUG na interface (ğŸ› DEBUG)
    * FunÃ§Ã£o showDebugInfo() mostra estado completo
    * VerificaÃ§Ã£o de crescimento do array
    * Alert se array nÃ£o crescer
    * Stack trace completo de exceÃ§Ãµes
    
    DEBUGGING:
    * 50+ linhas de console.log por waypoint
    * BotÃ£o DEBUG visÃ­vel na interface
    * Alert com estado do sistema
    * Timestamps em cada operaÃ§Ã£o
    * VerificaÃ§Ã£o de consistÃªncia arrays
  
  FUNCIONALIDADES PRINCIPAIS:
  âœ“ Cadastro completo de viagem (embarcaÃ§Ã£o, origem, destino, velocidade)
  âœ“ Rota automÃ¡tica ao adicionar waypoints no mapa
  âœ“ CÃ¡lculo automÃ¡tico de ETA para cada waypoint
  âœ“ CÃ¡lculo de consumo de combustÃ­vel em tempo real
  âœ“ GeraÃ§Ã£o de relatÃ³rio HTML profissional exportÃ¡vel
  âœ“ Lista detalhada de waypoints com horÃ¡rios e consumos
  âœ“ Mapa interativo OpenSeaMap com todas camadas
  âœ“ Database de 69 farÃ³is da costa brasileira
  âœ“ ImportaÃ§Ã£o/exportaÃ§Ã£o GPX
  âœ“ Interface mobile-first responsiva
  âœ“ RenderizaÃ§Ã£o correta em smartphones e tablets
  
  CHANGELOG:
  v2.0.2 (15/12/2024) - CORREÃ‡ÃƒO CRÃTICA DE RENDERIZAÃ‡ÃƒO MOBILE
    BUG CORRIGIDO:
    * Mapa nÃ£o renderizava em mobile (black screen)
    * Waypoints nÃ£o sendo contabilizados devido ao mapa nÃ£o carregar
    
    CORREÃ‡Ã•ES IMPLEMENTADAS:
    * CSS do map-container com altura explÃ­cita (min-height: 400px)
    * Altura calc(100vh - 200px) para mobile
    * touch-action: none para prevenir gestos do navegador
    * Position absolute no #map para garantir renderizaÃ§Ã£o
    * map.invalidateSize() apÃ³s 250ms da inicializaÃ§Ã£o
    * Listener window.resize para redimensionar mapa
    * Listener orientationchange para rotation em mobile
    * VerificaÃ§Ã£o de dimensÃµes do container antes de criar mapa
    * ForÃ§a altura de 400px se container tiver altura zero
    * Logging detalhado de dimensÃµes
    
  v2.0.1 (15/12/2024) - CORREÃ‡ÃƒO CRÃTICA MOBILE
    BUG CORRIGIDO:
    * Apenas 1 waypoint sendo registrado em dispositivos mÃ³veis
    
    CORREÃ‡Ã•ES IMPLEMENTADAS:
    * Event listener otimizado com suporte a 'tap' (mobile-specific)
    * ProteÃ§Ã£o contra mÃºltiplos cliques simultÃ¢neos (flag isProcessingWaypoint)
    * Debounce de 300ms para evitar registros duplicados
    * Logging detalhado para debug em mobile (console.log completo)
    * Melhor handling de eventos touch vs click
    
    MODIFICAÃ‡Ã•ES:
    - BotÃ£o "â• Waypoint" REMOVIDO (conforme solicitado)
    - Waypoints agora sÃ³ sÃ£o criados clicando/tocando no mapa
    - Event listener duplo (click + tap) para mÃ¡xima compatibilidade
    - Flag de processamento evita race conditions
    
  v2.0.0 (15/12/2024) - Sistema Completo de Planejamento
    NOVIDADES:
    + Modal de configuraÃ§Ã£o de viagem com dados da embarcaÃ§Ã£o
    + CriaÃ§Ã£o automÃ¡tica de rota ao adicionar waypoints
    + CÃ¡lculo de ETA (Estimated Time of Arrival) para cada waypoint
    + Sistema de consumo de combustÃ­vel (litros/hora)
    + Saldo de combustÃ­vel em tempo real
    + GeraÃ§Ã£o de relatÃ³rio HTML profissional
    + Consumo acumulado por waypoint
    + Consumo por perÃ­odo de 12 horas
    + Visibilidade de farÃ³is por waypoint
    + ExportaÃ§Ã£o de relatÃ³rio completo
    
    MODIFICAÃ‡Ã•ES:
    * Rota agora Ã© criada automaticamente (sem necessidade de botÃ£o separado)
    * Interface expandida com dados de viagem
    * Footer com informaÃ§Ãµes de combustÃ­vel e ETA
    * Sistema de validaÃ§Ã£o de dados
    
  v1.0.0 (15/12/2024) - ImplementaÃ§Ã£o inicial
    - Sistema de mapa base com OpenSeaMap
    - Waypoints manuais
    - Database de farÃ³is
    - Import/Export GPX bÃ¡sico
  
  ESTRUTURA DE DADOS:
  
  tripData = {
    vesselName: String,      // Nome da embarcaÃ§Ã£o
    origin: String,          // Porto de origem
    destination: String,     // Porto de destino
    departureDate: Date,     // Data e hora de saÃ­da
    speedKnots: Number,      // Velocidade mÃ©dia em nÃ³s
    fuelInitial: Number,     // Saldo inicial de combustÃ­vel (L)
    fuelConsumption: Number  // Consumo em litros/hora
  }
  
  waypoint = {
    id: Number,
    name: String,
    lat: Number,
    lng: Number,
    eta: Date,               // Hora estimada de chegada
    distance: Number,        // DistÃ¢ncia atÃ© prÃ³ximo waypoint
    fuelUsed: Number,        // CombustÃ­vel usado atÃ© este ponto
    fuelRemaining: Number,   // CombustÃ­vel restante
    nearestLighthouse: Object,
    lighthouseVisible: Boolean
  }
  
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema profissional de planejamento de viagem marÃ­tima costeira do Brasil">
  <meta name="author" content="Jossian Brito (Charlie Bravo)">
  <meta name="keywords"
    content="navegaÃ§Ã£o costeira, planejamento de viagem, farÃ³is, Brasil, OpenSeaMap, GPX, rebocadores">

  <title>Coastal Navigator Brasil v2.0.9 - Planejamento de Viagem</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <style>
    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      CSS VARIABLES - Sistema de Design MarÃ­timo
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    :root {
      /* Cores Principais */
      --deep-ocean: #0A1929;
      --navigation-blue: #1976D2;
      --lighthouse-amber: #FFA726;
      --chart-white: #F5F5F5;
      --warning-red: #D32F2F;
      --success-green: #4CAF50;

      /* Cores SecundÃ¡rias */
      --deck-gray: #37474F;
      --sea-foam: #00BCD4;
      --sunset-orange: #FF6F00;
      --night-navy: #0D47A1;

      /* Tipografia */
      --font-display: 'Orbitron', monospace;
      --font-body: 'Rajdhani', sans-serif;

      /* EspaÃ§amento */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;

      /* TransiÃ§Ãµes */
      --transition-fast: 0.2s ease;
      --transition-normal: 0.3s ease;
      --transition-slow: 0.5s ease;
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      RESET E BASE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-body);
      background: var(--deep-ocean);
      color: var(--chart-white);
      overflow: hidden;
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      LAYOUT PRINCIPAL - Container da AplicaÃ§Ã£o
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      HEADER - Barra de Controles
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    .app-header {
      background: linear-gradient(135deg, var(--deep-ocean), var(--night-navy));
      padding: var(--spacing-md);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      border-bottom: 2px solid var(--navigation-blue);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      max-width: 1400px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .logo h1 {
      font-family: var(--font-display);
      font-size: clamp(1.2rem, 3vw, 1.8rem);
      color: var(--lighthouse-amber);
      text-shadow: 0 0 10px rgba(255, 167, 38, 0.5);
      letter-spacing: 2px;
    }

    .logo .version {
      font-size: 0.7rem;
      color: var(--sea-foam);
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .btn {
      background: var(--navigation-blue);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-family: var(--font-body);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .btn:hover {
      background: #1565C0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--lighthouse-amber);
      color: var(--deep-ocean);
    }

    .btn-primary:hover {
      background: #FF9800;
    }

    .btn-success {
      background: var(--success-green);
    }

    .btn-success:hover {
      background: #45a049;
    }

    .btn-danger {
      background: var(--warning-red);
    }

    .btn-danger:hover {
      background: #C62828;
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      MODAL - ConfiguraÃ§Ã£o de Viagem
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 25, 41, 0.95);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      animation: fadeIn var(--transition-normal);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: linear-gradient(135deg, var(--deck-gray), var(--deep-ocean));
      border: 2px solid var(--navigation-blue);
      border-radius: 12px;
      padding: var(--spacing-xl);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
      animation: slideUp var(--transition-normal);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      border-bottom: 2px solid var(--lighthouse-amber);
      padding-bottom: var(--spacing-md);
    }

    .modal-header h2 {
      font-family: var(--font-display);
      color: var(--lighthouse-amber);
      font-size: 1.5rem;
    }

    .modal-close {
      background: var(--warning-red);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      background: #C62828;
      transform: rotate(90deg);
    }

    .form-group {
      margin-bottom: var(--spacing-md);
    }

    .form-group label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: 600;
      color: var(--sea-foam);
      font-size: 0.95rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--navigation-blue);
      border-radius: 6px;
      color: var(--chart-white);
      font-family: var(--font-body);
      font-size: 1rem;
      transition: all var(--transition-fast);
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--lighthouse-amber);
      box-shadow: 0 0 0 3px rgba(255, 167, 38, 0.2);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
    }

    .form-help {
      font-size: 0.85rem;
      color: #90CAF9;
      margin-top: var(--spacing-xs);
    }

    .modal-footer {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
      padding-top: var(--spacing-md);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      MAPA - Ãrea Principal (CORRIGIDO v2.0.2 para Mobile)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    .map-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      /* CORREÃ‡ÃƒO v2.0.2: Altura mÃ­nima para mobile */
      min-height: 400px;
      height: calc(100vh - 200px);
      /* Viewport height menos header/footer */
    }

    #map {
      width: 100%;
      height: 100%;
      /* CORREÃ‡ÃƒO v2.0.2: Prevenir zoom e gestos do navegador */
      touch-action: none;
      /* CORREÃ‡ÃƒO v2.0.2: Garantir renderizaÃ§Ã£o */
      position: absolute;
      top: 0;
      left: 0;
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      PAINEL DE INFORMAÃ‡Ã•ES LATERAL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    .info-panel {
      position: absolute;
      top: 0;
      right: -350px;
      width: 350px;
      height: 100%;
      background: linear-gradient(180deg, var(--deep-ocean), var(--deck-gray));
      box-shadow: -4px 0 16px rgba(0, 0, 0, 0.5);
      transition: right var(--transition-normal);
      z-index: 500;
      overflow-y: auto;
      border-left: 2px solid var(--navigation-blue);
    }

    .info-panel.active {
      right: 0;
    }

    .info-section {
      padding: var(--spacing-lg);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-title {
      font-family: var(--font-display);
      font-size: 1.1rem;
      color: var(--lighthouse-amber);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .waypoint-item,
    .lighthouse-item {
      background: rgba(255, 255, 255, 0.05);
      padding: var(--spacing-md);
      border-radius: 6px;
      margin-bottom: var(--spacing-sm);
      border-left: 3px solid var(--navigation-blue);
      transition: all var(--transition-fast);
    }

    .waypoint-item:hover,
    .lighthouse-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-left-color: var(--lighthouse-amber);
    }

    .item-name {
      font-weight: 700;
      font-size: 1.05rem;
      margin-bottom: var(--spacing-xs);
      color: var(--sea-foam);
    }

    .item-details {
      font-size: 0.9rem;
      line-height: 1.6;
      color: #CFD8DC;
    }

    .item-details strong {
      color: var(--chart-white);
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      TRIP INFO BAR - Barra de InformaÃ§Ãµes da Viagem
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    .trip-info-bar {
      background: linear-gradient(135deg, var(--night-navy), var(--deck-gray));
      padding: var(--spacing-sm) var(--spacing-md);
      border-bottom: 2px solid var(--navigation-blue);
      display: none;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
    }

    .trip-info-bar.active {
      display: flex;
    }

    .trip-info-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .trip-info-label {
      color: var(--sea-foam);
      font-weight: 600;
    }

    .trip-info-value {
      color: var(--chart-white);
      font-weight: 700;
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      FOOTER - Barra de Status
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    .app-footer {
      background: linear-gradient(135deg, var(--deep-ocean), var(--deck-gray));
      padding: var(--spacing-sm) var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      border-top: 2px solid var(--navigation-blue);
      font-size: 0.9rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .status-value {
      font-weight: 700;
      color: var(--lighthouse-amber);
    }

    .status-warning {
      color: var(--warning-red);
    }

    .status-success {
      color: var(--success-green);
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      LIGHTHOUSE MARKER - CustomizaÃ§Ã£o
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    .lighthouse-marker {
      width: 24px;
      height: 24px;
      background: var(--lighthouse-amber);
      border: 2px solid var(--deep-ocean);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(255, 167, 38, 0.7);
      }

      50% {
        box-shadow: 0 0 0 10px rgba(255, 167, 38, 0);
      }
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ANIMAÃ‡Ã•ES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      RESPONSIVIDADE - Mobile First
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    @media (max-width: 768px) {
      .controls {
        width: 100%;
        justify-content: center;
      }

      .btn {
        flex: 1;
        justify-content: center;
        font-size: 0.85rem;
        padding: 8px 12px;
      }

      .info-panel {
        width: 90vw;
        right: -90vw;
      }

      .modal {
        width: 95%;
        padding: var(--spacing-lg);
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .trip-info-bar {
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .logo h1 {
        font-size: 1rem;
      }

      .app-header {
        padding: var(--spacing-sm);
      }

      .btn {
        font-size: 0.8rem;
        padding: 6px 10px;
      }
    }

    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      TOUR / ONBOARDING STYLES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */
    .tour-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9000;
      display: none;
      pointer-events: none;
      /* Allows clicks to pass through to highlighted elements if needed, but we usually block */
    }

    .tour-overlay.active {
      display: block;
      pointer-events: auto;
    }

    .tour-highlight {
      position: absolute;
      border-radius: 4px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
      z-index: 9001;
      transition: all 0.3s ease;
      pointer-events: none;
      border: 2px solid var(--lighthouse-amber);
    }

    .tour-tooltip {
      position: absolute;
      background: linear-gradient(135deg, var(--deep-ocean), var(--deck-gray));
      border: 1px solid var(--navigation-blue);
      color: var(--chart-white);
      padding: 20px;
      border-radius: 8px;
      width: 300px;
      max-width: 90vw;
      /* Responsividade Mobile */
      z-index: 9002;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      font-family: var(--font-body);
      transition: all 0.3s ease;
    }

    .tour-title {
      font-family: var(--font-display);
      color: var(--lighthouse-amber);
      font-size: 1.1rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tour-text {
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 20px;
      color: #CFD8DC;
    }

    .tour-controls {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .tour-btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid var(--navigation-blue);
      background: transparent;
      color: var(--sea-foam);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .tour-btn:hover {
      background: rgba(25, 118, 210, 0.2);
    }

    .tour-btn-primary {
      background: var(--navigation-blue);
      color: white;
      border: none;
    }

    .tour-btn-primary:hover {
      background: #1565C0;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- 
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      HEADER - Barra de Controles
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    <header class="app-header">
      <div class="header-content">
        <div class="logo">
          <h1>âš“ COASTAL NAVIGATOR BRASIL <span class="version">v2.0.9</span></h1>
        </div>

        <div class="controls">
          <button class="btn btn-primary" onclick="openTripModal()">
            ğŸš¢ Nova Viagem
          </button>
          <button class="btn btn-danger" onclick="clearAll()">
            ğŸ—‘ï¸ Limpar
          </button>
          <button class="btn" onclick="document.getElementById('gpxFile').click()">
            ğŸ“ Importar
          </button>
          <button class="btn" onclick="exportGPX()">
            ğŸ’¾ Exportar
          </button>
          <button class="btn btn-success" onclick="generateReport()" id="reportBtn" style="display: none;">
            ğŸ“Š Gerar RelatÃ³rio
          </button>
          <button class="btn" onclick="showDebugInfo()" style="background: #9C27B0;">
            ğŸ› DEBUG
          </button>
          <button class="btn" onclick="toggleInfo()">
            â„¹ï¸ Info
          </button>
          <button class="btn" onclick="startOnboardingTour()" style="background: #00897B;">
            â“ Tour
          </button>
        </div>
      </div>
    </header>

    <!-- 
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      TRIP INFO BAR - InformaÃ§Ãµes da Viagem Atual
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    <div class="trip-info-bar" id="tripInfoBar">
      <div class="trip-info-item">
        <span class="trip-info-label">ğŸš¢ EmbarcaÃ§Ã£o:</span>
        <span class="trip-info-value" id="infoVessel">-</span>
      </div>
      <div class="trip-info-item">
        <span class="trip-info-label">ğŸ“ Origem:</span>
        <span class="trip-info-value" id="infoOrigin">-</span>
      </div>
      <div class="trip-info-item">
        <span class="trip-info-label">ğŸ¯ Destino:</span>
        <span class="trip-info-value" id="infoDestination">-</span>
      </div>
      <div class="trip-info-item">
        <span class="trip-info-label">â±ï¸ Partida:</span>
        <span class="trip-info-value" id="infoDeparture">-</span>
      </div>
      <div class="trip-info-item">
        <span class="trip-info-label">ğŸš€ Velocidade:</span>
        <span class="trip-info-value" id="infoSpeed">-</span>
      </div>
    </div>

    <!-- 
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      MAPA - Carta NÃ¡utica Digital
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    <main class="map-container">
      <div id="map"></div>

      <!-- Painel de InformaÃ§Ãµes Lateral -->
      <aside class="info-panel" id="infoPanel">
        <div class="info-section">
          <h2 class="info-title">ğŸ“ Waypoints</h2>
          <div id="waypoints-list"></div>
        </div>

        <div class="info-section">
          <h2 class="info-title">ğŸ—ºï¸ Derrota</h2>
          <div id="route-info"></div>
        </div>

        <div class="info-section">
          <h2 class="info-title">â›½ CombustÃ­vel</h2>
          <div id="fuel-info"></div>
        </div>

        <div class="info-section">
          <h2 class="info-title">ğŸ’¡ FarÃ³is PrÃ³ximos</h2>
          <div id="lighthouses-list"></div>
        </div>
      </aside>
    </main>

    <!-- 
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      FOOTER - Barra de Status
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    <footer class="app-footer">
      <div class="status-item">
        <span>ğŸ“ Waypoints:</span>
        <span class="status-value" id="waypoint-count">0</span>
      </div>

      <div class="status-item">
        <span>ğŸ“ DistÃ¢ncia Total:</span>
        <span class="status-value" id="total-distance">0 NM</span>
      </div>

      <div class="status-item">
        <span>â±ï¸ Tempo Estimado:</span>
        <span class="status-value" id="total-time">0h</span>
      </div>

      <div class="status-item">
        <span>â›½ CombustÃ­vel:</span>
        <span class="status-value" id="fuel-remaining">0 L</span>
      </div>

      <div class="status-item">
        <span>ğŸ’¡ FarÃ³is:</span>
        <span class="status-value">98</span>
      </div>

      <div class="status-item">
        <span>Â© 2024 Jossian Brito</span>
      </div>
    </footer>
  </div>

  <!-- 
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    MODAL - ConfiguraÃ§Ã£o de Viagem
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  <div class="modal-overlay" id="tripModal">
    <div class="modal">
      <div class="modal-header">
        <h2>ğŸš¢ ConfiguraÃ§Ã£o de Viagem</h2>
        <button class="modal-close" onclick="closeTripModal()">Ã—</button>
      </div>

      <form id="tripForm" onsubmit="saveTripData(event)">
        <div class="form-group">
          <label for="vesselName">Nome da EmbarcaÃ§Ã£o</label>
          <input type="text" id="vesselName" required placeholder="Ex: RT ATLÃ‚NTICO">
          <div class="form-help">Nome do rebocador ou embarcaÃ§Ã£o</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="origin">Porto de Origem</label>
            <input type="text" id="origin" required placeholder="Ex: Fortaleza">
          </div>

          <div class="form-group">
            <label for="destination">Porto de Destino</label>
            <input type="text" id="destination" required placeholder="Ex: Santos">
          </div>
        </div>

        <div class="form-group">
          <label for="departureDate">Data e Hora de SaÃ­da</label>
          <input type="datetime-local" id="departureDate" required>
          <div class="form-help">Data e hora local de partida</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="speedKnots">Velocidade MÃ©dia (nÃ³s)</label>
            <input type="number" id="speedKnots" required min="1" max="50" step="0.1" placeholder="Ex: 10.5">
            <div class="form-help">Velocidade mÃ©dia de navegaÃ§Ã£o</div>
          </div>

          <div class="form-group">
            <label for="fuelConsumption">Consumo (L/h)</label>
            <input type="number" id="fuelConsumption" required min="0" step="0.1" placeholder="Ex: 85.5">
            <div class="form-help">Consumo em litros por hora</div>
          </div>
        </div>

        <div class="form-group">
          <label for="fuelInitial">Saldo Inicial de CombustÃ­vel (L)</label>
          <input type="number" id="fuelInitial" required min="0" step="1" placeholder="Ex: 50000">
          <div class="form-help">Quantidade de combustÃ­vel a bordo</div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-danger" onclick="closeTripModal()" style="flex: 1;">
            Cancelar
          </button>
          <button type="submit" class="btn btn-success" style="flex: 2;">
            ğŸ’¾ Iniciar Planejamento
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Input oculto para importaÃ§Ã£o GPX -->
  <input type="file" id="gpxFile" accept=".gpx" style="display: none;" onchange="importGPX(event)">

  <!-- TOUR ELEMENTS -->
  <div class="tour-overlay" id="tourOverlay"></div>
  <div class="tour-highlight" id="tourHighlight"></div>
  <div class="tour-tooltip" id="tourTooltip">
    <div class="tour-title" id="tourTitle">TÃ­tulo</div>
    <div class="tour-text" id="tourText">Texto do passo.</div>
    <div class="tour-controls">
      <button class="tour-btn" onclick="endTour()">Pular</button>
      <div style="display:flex; gap:10px;">
        <button class="tour-btn" id="tourPrevBtn" onclick="prevTourStep()">Anterior</button>
        <button class="tour-btn tour-btn-primary" id="tourNextBtn" onclick="nextTourStep()">PrÃ³ximo</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JavaScript Library -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /*
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      JAVASCRIPT - Sistema Completo de Planejamento de Viagem
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    AUTOR: Jossian Brito (Charlie Bravo)
    DATA: 15/12/2024
    VERSÃƒO: 2.0.0
    
    MODIFICAÃ‡Ã•ES NESTA VERSÃƒO:
    + Sistema completo de planejamento de viagem
    + CÃ¡lculos automÃ¡ticos de ETA por waypoint
    + Sistema de consumo de combustÃ­vel em tempo real
    + CriaÃ§Ã£o automÃ¡tica de rota ao adicionar waypoints
    + GeraÃ§Ã£o de relatÃ³rio HTML profissional exportÃ¡vel
    + ValidaÃ§Ã£o de dados de entrada
    + Alertas de combustÃ­vel insuficiente
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    */

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VARIÃVEIS GLOBAIS - Estado da AplicaÃ§Ã£o
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /*
    VARIÃVEIS DE ESTADO:
    
    - map: InstÃ¢ncia do Leaflet para controle do mapa
    - waypoints: Array de objetos contendo todos waypoints da rota
    - waypointMarkers: Array de marcadores Leaflet para os waypoints
    - route: Polyline do Leaflet representando a rota
    - tripData: Objeto com dados da viagem (embarcaÃ§Ã£o, consumo, etc)
    - waypointCounter: Contador incremental para nomear waypoints
    - lighthous: Database de 69 farÃ³is da costa brasileira
    
    ANALOGIA MARÃTIMA - VARIÃVEIS COMO COMPARTIMENTOS:
    Cada variÃ¡vel Ã© como um compartimento especÃ­fico no rebocador:
    - map â†’ Ponte de comando (controle central)
    - waypoints â†’ Carta nÃ¡utica (pontos marcados)
    - tripData â†’ DiÃ¡rio de bordo (registro da viagem)
    - lighthouses â†’ Almanaque de farÃ³is (referÃªncias costeiras)
    */
    let map;                    // InstÃ¢ncia do mapa Leaflet
    let waypoints = [];         // Array de waypoints da rota
    let waypointMarkers = [];   // Array de marcadores visuais
    let route = null;           // Linha da rota no mapa
    let tripData = null;        // Dados da viagem atual
    let waypointCounter = 1;    // Contador para nomes de waypoints

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATABASE DE FARÃ“IS - 69 FarÃ³is da Costa Brasileira
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /*
    ESTRUTURA DE DADOS - FARÃ“IS:
    
    Cada farol Ã© um objeto com 6 propriedades essenciais:
    {
      name: String - Nome oficial do farol
      lat: Number - Latitude em graus decimais (4 casas)
      lng: Number - Longitude em graus decimais (4 casas)
      height: Number - Altura focal em metros
      range: Number - Alcance nominal em milhas nÃ¡uticas
      character: String - CaracterÃ­stica luminosa (ex: "Fl W 5s")
    }
    
    FONTE DOS DADOS: DHN (Diretoria de Hidrografia e NavegaÃ§Ã£o - Marinha do Brasil)
    */
    const lighthouses = [

      // Norte (AmapÃ¡, ParÃ¡, MaranhÃ£o)
      { name: "Farol de SimÃ£o Grande", lat: -0.2568, lng: -48.4032, height: 42, range: 16, character: "Fl W 5s" }, // DHN
      { name: "Farol de SalinÃ³polis", lat: -0.6155, lng: -47.3565, height: 93, range: 46, character: "Fl W 6s" }, // DHN
      { name: "Farol de CaetÃ©", lat: -0.817, lng: -46.6143, height: 214, range: 15, character: "Fl W 10s" }, // DHN
      { name: "Farol de ApeÃº", lat: -0.9103, lng: -46.189, height: 215, range: 15, character: "Fl W 10s" }, // DHN
      { name: "Farol de SÃ£o JoÃ£o", lat: -1.282, lng: -44.9033, height: 21, range: 20, character: "Fl W 10s" }, // DHN
      { name: "Farol de LenÃ§Ã³is Grandes", lat: -2.3797, lng: -43.2697, height: 21, range: 17, character: "Fl W 10s" }, // DHN
      { name: "Farol de PreguiÃ§as", lat: -2.5925, lng: -42.7073, height: 21, range: 43, character: "Fl W 10s" }, // DHN
      { name: "Farol de Jericoacoara", lat: -2.788, lng: -40.4997, height: 21, range: 19, character: "Fl W 10s" }, // DHN
      { name: "Farol de Pedra do Sal", lat: -2.8037, lng: -41.7293, height: 515, range: 15, character: "Fl W 10s" }, // DHN
      { name: "Farol de MundaÃº", lat: -3.1763, lng: -39.362, height: 21, range: 14, character: "Fl W 10s" }, // DHN
      { name: "Farol de Paracuru", lat: -3.3972, lng: -39.0163, height: 21, range: 27, character: "Fl W 10s" }, // DHN
      { name: "Farol do Mucuripe", lat: -3.7263, lng: -38.4717, height: 72, range: 27, character: "Fl(2) W 10s" }, // DHN - Novo Farol
      { name: "Farol de Morro Branco", lat: -4.1585, lng: -38.1075, height: 107, range: 24, character: "Fl(5) W 60s" }, // G 0125.5
      { name: "Farol de Aracati", lat: -4.4087, lng: -37.7698, height: 16, range: 12, character: "Fl(2) W 6s" }, // G 0126
      { name: "Farol de Fernando de Noronha", lat: -3.85, lng: -32.4167, height: 58, range: 30, character: "Fl(3)W 15s" }, // Validated - Ilha de Fernando de Noronha - importante para navegaÃ§Ã£o
      { name: "Farol de Rocas", lat: -3.856, lng: -33.8175, height: 51, range: 13, character: "Fl W 10s" }, // DHN
      { name: "Farol de Orange", lat: 4.431, lng: -51.541, height: 110, range: 18, character: "Fl(2) W 14s" }, // DHN
      { name: "Farol de Ponta Cajuais", lat: -4.71, lng: -37.361, height: 21, range: 19, character: "Fl W 10s" }, // DHN
      { name: "Farol de Ponta do Mel", lat: -4.9612, lng: -36.8767, height: 106, range: 41, character: "LFl W 30s" }, // G 0154
      { name: "Farol de Galinhos", lat: -5.0887, lng: -36.2905, height: 14, range: 12, character: "Fl W 10s" }, // G 0158

      // Nordeste (PI, CE, RN, PB, PE, AL, SE, BA)
      { name: "Farol de Calcanhar", lat: -5.1608, lng: -35.4868, height: 22, range: 38, character: "Fl W 10s" }, // DHN
      { name: "Farol Santo Alberto", lat: -5.0526, lng: -36.0379, height: 32, range: 17, character: "Fl W 6s" }, // OpenSeaMap - >15m verificado
      { name: "Farol de SÃ£o Roque", lat: -5.4887, lng: -35.2618, height: 810, range: 21, character: "Fl W 6s" }, // DHN
      { name: "Farol de Natal", lat: -5.7515, lng: -35.1947, height: 811, range: 39, character: "Fl W 10s" }, // DHN
      { name: "Farol de Bacopari", lat: -6.3745, lng: -34.9922, height: 30, range: 15, character: "Fl(2) W 10s" }, // G 0184
      { name: "Farol de Pedra Seca", lat: -6.9562, lng: -34.8228, height: 830, range: 16, character: "Fl W 6s" }, // DHN
      { name: "Farol de Cabo Branco", lat: -7.1493, lng: -34.7962, height: 806, range: 27, character: "Fl W 10s" }, // DHN
      { name: "Farol de Ponta de Pedras", lat: -7.6300, lng: -34.8120, height: 56, range: 18, character: "Fl(3) W 15s" }, // G 0192
      { name: "Farol de Olinda", lat: -8.011, lng: -34.8473, height: 66, range: 46, character: "Fl W 10s" }, // DHN
      { name: "Farol de Santo Agostinho", lat: -8.3515, lng: -34.9473, height: 912, range: 22, character: "Fl W 10s" }, // DHN
      { name: "Farol de TamandarÃ©", lat: -8.7580, lng: -35.0997, height: 25, range: 14, character: "Fl(3) W 10s" }, // OpenSeaMap - >15m verificado
      { name: "Farol de Porto de Pedras", lat: -9.1565, lng: -35.2982, height: 22, range: 24, character: "Fl(2) W 14s" }, // DHN
      { name: "Farol de MaceiÃ³", lat: -9.5153, lng: -35.8007, height: 920, range: 43, character: "Fl W 10s" }, // DHN
      { name: "Farol de Coruripe", lat: -10.16, lng: -36.135, height: 223, range: 14, character: "Fl(2) W 14s" }, // DHN
      { name: "Farol de Peba", lat: -10.4883, lng: -36.3877, height: 20, range: 12, character: "LFl W 15s" }, // G 0227
      { name: "Farol de Sergipe", lat: -10.9697, lng: -37.0362, height: 1, range: 39, character: "Fl W 10s" }, // DHN
      { name: "Farol de Mangue Seco", lat: -11.4628, lng: -37.3657, height: 55, range: 18, character: "Fl W 6s" }, // G 0234.2
      { name: "Farol de Itariri", lat: -11.9555, lng: -37.6223, height: 75, range: 18, character: "Fl W 15s" }, // G 0234.5
      { name: "Farol de SubaÃºma", lat: -12.2397, lng: -37.7732, height: 48, range: 23, character: "Fl W 10s" }, // G 0235
      { name: "Farol de ItapuÃ£", lat: -12.9568, lng: -38.3537, height: 22, range: 15, character: "Fl W 10s" }, // DHN
      { name: "Farol de Morro de SÃ£o Paulo", lat: -13.3755, lng: -38.9153, height: 89, range: 22, character: "Fl(2) W 15s" }, // G 0274
      { name: "Farol de Morro de Taipus", lat: -13.9558, lng: -38.9428, height: 76, range: 21, character: "Fl(3) W 15s" }, // G 0280
      { name: "Farol de Contas", lat: -14.2740, lng: -38.9858, height: 21, range: 13, character: "Fl W 10s" }, // G 0282
      { name: "Farol de IlhÃ©us", lat: -14.8057, lng: -39.0257, height: 120, range: 23, character: "Fl W 10s" }, // DHN
      { name: "Farol de Comandatuba", lat: -15.3518, lng: -38.9808, height: 45, range: 17, character: "Fl(3) W 15s" }, // G 0290.5

      // Sudeste (ES, RJ, SP)
      { name: "Farol de Belmonte", lat: -15.86, lng: -38.88, height: 43, range: 23, character: "Fl W 8s" }, // v2.0.5 - Adicionado em v2.0.5 por solicitaÃ§Ã£o
      { name: "Farol de Porto Seguro", lat: -16.4358, lng: -39.0638, height: 120, range: 26, character: "Fl W 10s" }, // DHN
      { name: "Farol de CorumbaÃº", lat: -16.8955, lng: -39.1137, height: 15, range: 12, character: "Fl W 10s" }, // G 0298
      { name: "Farol da Ponta da Baleia", lat: -17.6885, lng: -39.1408, height: 19, range: 12, character: "Fl W 5s" }, // G 0302
      { name: "Farol de Abrolhos", lat: -17.9642, lng: -38.6938, height: 1, range: 51, character: "Fl W 10s" }, // DHN
      { name: "Farol de SÃ£o Mateus", lat: -18.6143, lng: -39.7313, height: 22, range: 15, character: "Fl(2) W 14s" }, // DHN
      { name: "Farol de SuÃ§uraca", lat: -19.0967, lng: -39.7230, height: 64, range: 19, character: "Fl(2) W 30s" }, // G 0313.5
      { name: "Farol de Rio Doce", lat: -19.6512, lng: -39.8255, height: 1, range: 18, character: "Fl W 6s" }, // DHN
      { name: "Farol de Santa Luzia", lat: -20.3243, lng: -40.2675, height: 1, range: 34, character: "Fl W 10s" }, // DHN
      { name: "Farol de Escalvada", lat: -20.7, lng: -40.4067, height: 140, range: 15, character: "Fl W 10s" }, // DHN
      { name: "Farol de SÃ£o TomÃ©", lat: -22.042, lng: -41.0528, height: 40, range: 49, character: "Fl(2) W 67.5s" }, // DHN
      { name: "Farol de MacaÃ©", lat: -22.4163, lng: -41.7062, height: 1, range: 28, character: "Fl W 10s" }, // DHN
      { name: "Farol de Cabo Frio", lat: -22.8838, lng: -42.0188, height: 150, range: 49, character: "Fl W 10s" }, // DHN
      { name: "Farol de Ponta Negra", lat: -22.9607, lng: -42.6926, height: 20, range: 20, character: "Fl(2) W 10s" }, // G 0356
      { name: "Farol da Barra da Tijuca", lat: -22.9872, lng: -43.3683, height: 20, range: 15, character: "Fl W 10s" }, // OpenSeaMap - >15m verificado
      { name: "Farol de MaricÃ¡s", lat: -23.0152, lng: -42.9202, height: 21, range: 21, character: "LFl W 15s" }, // G 0358
      { name: "Farol da Ilha Pontuda", lat: -23.0380, lng: -43.3037, height: 22, range: 7, character: "Fl W R 10s" }, // G 0402
      { name: "Farol de Rasa", lat: -23.064, lng: -43.146, height: 1, range: 51, character: "Fl W 10s" }, // DHN
      { name: "Farol de Guaratiba", lat: -23.0810, lng: -43.5623, height: 16, range: 16, character: "Fl W 6s" }, // G 0404
      { name: "Farol de Marambaia", lat: -23.1157, lng: -43.8357, height: 13, range: 13, character: "Fl(2) W 10s" }, // G 0406
      { name: "Farol de Castelhanos", lat: -23.1678, lng: -44.0928, height: 1, range: 27, character: "Fl W 10s" }, // DHN
      { name: "Farol de Juatinga", lat: -23.2937, lng: -44.5053, height: 29, range: 29, character: "Fl W 10s" }, // G 0458
      { name: "Farol da VitÃ³ria", lat: -23.7513, lng: -45.0112, height: 23, range: 23, character: "Fl W 6s" }, // G 0466
      { name: "Farol de Ponta Grossa", lat: -23.7767, lng: -45.2307, height: 19, range: 19, character: "LFl W 15s" }, // G 0468
      { name: "Farol de Ponta do Boi", lat: -23.9665, lng: -45.2513, height: 23, range: 22, character: "Fl W 10s" }, // DHN
      { name: "Farol de Moela", lat: -24.0508, lng: -46.2635, height: 1, range: 40, character: "Fl W 10s" }, // DHN
      { name: "Farol de Alcatrazes", lat: -24.0958, lng: -45.7030, height: 13, range: 13, character: "Fl W 6s" }, // G 0490
      { name: "Farol de ConceiÃ§Ã£o", lat: -24.2363, lng: -46.691, height: 171, range: 16, character: "Fl W 10s" }, // DHN
      { name: "Farol de Laje de Santos", lat: -24.3198, lng: -46.1820, height: 15, range: 15, character: "Fl W 3s" }, // G 0495
      { name: "Farol de Queimada Grande", lat: -24.4790, lng: -46.6768, height: 21, range: 21, character: "Fl W 10s" }, // G 0512

      // Sul (PR, SC, RS)
      { name: "Farol de Bom Abrigo", lat: -25.1235, lng: -47.8625, height: 170, range: 28, character: "Fl W 10s" }, // DHN
      { name: "Farol da Ilha do Mel", lat: -25.5333, lng: -48.3, height: 54, range: 27, character: "Fl(3)W 15s" }, // Validated - Entrada do Porto de ParanaguÃ¡
      { name: "Farol de Conchas", lat: -25.5392, lng: -48.2908, height: 182, range: 25, character: "Fl W 10s" }, // DHN
      { name: "Farol de Ilha da Paz", lat: -26.1772, lng: -48.4848, height: 1, range: 26, character: "Fl W 10s" }, // DHN
      { name: "Farol da Ponta do Varrido", lat: -26.7850, lng: -48.5858, height: 50, range: 18, character: "Fl W 6s" }, // G 0551
      { name: "Farol de Arvoredo", lat: -27.296, lng: -48.3565, height: 1, range: 24, character: "Fl W 10s" }, // DHN
      { name: "Farol da Ponta da Galheta", lat: -27.5758, lng: -48.4165, height: 150, range: 16, character: "Fl W 10s" }, // G 0562.5
      { name: "Farol de Santa Marta", lat: -28.6038, lng: -48.8127, height: 1, range: 46, character: "Fl W 10s" }, // DHN
      { name: "Farol de AraranguÃ¡", lat: -28.9340, lng: -49.3610, height: 82, range: 22, character: "Fl(3) W 20s" }, // G 0602
      { name: "Farol de Torres", lat: -29.3447, lng: -49.7295, height: 23, range: 23, character: "Fl W 10s" }, // DHN
      { name: "Farol de TramandaÃ­", lat: -30.0082, lng: -50.1355, height: 201, range: 23, character: "Fl W 10s" }, // DHN
      { name: "Farol de Cidreira", lat: -30.1578, lng: -50.1973, height: 33, range: 20, character: "Fl W 6s" }, // G 0608
      { name: "Farol de Berta", lat: -30.4003, lng: -50.2903, height: 42, range: 23, character: "Fl W 10s" }, // G 0610
      { name: "Farol de SolidÃ£o", lat: -30.7013, lng: -50.4808, height: 24, range: 15, character: "Fl(2) W 12s" }, // G 0612
      { name: "Farol de Mostardas", lat: -31.249, lng: -50.908, height: 23, range: 40, character: "Fl W 10s" }, // DHN
      { name: "Farol CapÃ£o da Marca de Fora", lat: -31.5018, lng: -51.1883, height: 42, range: 17, character: "Fl(3) W 10s" }, // G 0631.3
      { name: "Farol de ConceiÃ§Ã£o", lat: -31.7305, lng: -51.4817, height: 33, range: 16, character: "Fl(2) W 10s" }, // G 0616
      { name: "Farol de Estreito", lat: -31.8813, lng: -51.7725, height: 42, range: 17, character: "LFl W 15s" }, // G 0618
      { name: "Farol da Barra (Rio Grande)", lat: -32.1178, lng: -52.0768, height: 32, range: 30, character: "Oc(6) W 21s" }, // G 0620
      { name: "Farol de ChuÃ­", lat: -33.7463, lng: -53.3768, height: 23, range: 46, character: "Fl W 10s" }, // DHN - Corrigido

      // Ilhas OceÃ¢nicas
      { name: "Farol de SÃ£o Pedro e SÃ£o Paulo", lat: 0.9167, lng: -29.3333, height: 35, range: 20, character: "Fl(3)W 12s" }, // Validated - ArquipÃ©lago SÃ£o Pedro e SÃ£o Paulo
      { name: "Farol de Martin Vaz", lat: -20.5, lng: -28.85, height: 42, range: 23, character: "Fl W 8s" }, // Validated - ArquipÃ©lago Martin Vaz - navegaÃ§Ã£o oceÃ¢nica
      { name: "Farol de Trindade", lat: -20.5167, lng: -29.3167, height: 58, range: 28, character: "Fl(4)W 15s" }, // Validated - Ilha Trindade - navegaÃ§Ã£o oceÃ¢nica

    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INICIALIZAÃ‡ÃƒO DO MAPA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /*
    FUNÃ‡ÃƒO: initMap()
    
    Inicializa o mapa Leaflet com:
    - Centro na costa do Brasil (Fortaleza como referÃªncia)
    - Zoom apropriado para visualizaÃ§Ã£o costeira
    - Camadas OpenSeaMap + OpenStreetMap
    - Marcadores dos 69 farÃ³is
    - Event listeners para interaÃ§Ã£o
    
    COMPLEXIDADE: O(n) onde n = nÃºmero de farÃ³is (69)
    */
    function initMap() {
      console.log('ğŸ—ºï¸ Iniciando mapa...');

      // CORREÃ‡ÃƒO v2.0.2: Verificar dimensÃµes do container antes de criar mapa
      const mapContainer = document.getElementById('map');
      const containerHeight = mapContainer.offsetHeight;
      const containerWidth = mapContainer.offsetWidth;

      console.log('ğŸ“ DimensÃµes do container:');
      console.log('   Largura:', containerWidth, 'px');
      console.log('   Altura:', containerHeight, 'px');

      if (containerHeight === 0 || containerWidth === 0) {
        console.warn('âš ï¸ Container com dimensÃµes zero! ForÃ§ando altura...');
        mapContainer.style.height = '400px';
        mapContainer.style.minHeight = '400px';
      }

      // Criar mapa centrado na costa brasileira (Fortaleza, CE)
      map = L.map('map').setView([-3.7147, -38.4781], 6);

      // Camada base OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Camada OpenSeaMap (marcaÃ§Ãµes nÃ¡uticas)
      L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenSeaMap contributors',
        maxZoom: 18
      }).addTo(map);

      // Adicionar marcadores dos farÃ³is
      lighthouses.forEach(lh => {
        const marker = L.circleMarker([lh.lat, lh.lng], {
          radius: 6,
          fillColor: '#FFA726',
          color: '#0A1929',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8,
          className: 'lighthouse-marker'
        }).addTo(map);

        // Popup com informaÃ§Ãµes do farol
        marker.bindPopup(`
          <div style="font-family: 'Rajdhani', sans-serif; min-width: 200px;">
            <strong style="color: #FFA726; font-size: 1.1rem;">ğŸ’¡ ${lh.name}</strong><br>
            <strong>PosiÃ§Ã£o:</strong> ${lh.lat.toFixed(4)}Â°, ${lh.lng.toFixed(4)}Â°<br>
            <strong>Altura:</strong> ${lh.height}m<br>
            <strong>Alcance:</strong> ${lh.range} NM<br>
            <strong>CaracterÃ­stica:</strong> ${lh.character}
          </div>
        `, {
          autoPan: true,
          autoPanPadding: [50, 50],
          maxWidth: 300
        });
      });

      // Event listener para clique no mapa (adicionar waypoint)
      // CORREÃ‡ÃƒO v2.0.1: Otimizado para mobile com proteÃ§Ã£o contra mÃºltiplos cliques
      let isProcessingWaypoint = false;
      let processingTimeout = null;

      function handleMapClick(e) {
        console.log('ğŸ—ºï¸ Mapa clicado/tocado:', e.latlng);
        console.log('   isProcessingWaypoint:', isProcessingWaypoint);

        // ProteÃ§Ã£o: Se jÃ¡ estÃ¡ processando, ignorar
        if (isProcessingWaypoint) {
          console.log('â³ JÃ¡ processando waypoint, ignorando clique...');
          console.log('   Aguardando liberaÃ§Ã£o da flag...');
          return;
        }

        if (!tripData) {
          console.log('âŒ tripData nÃ£o configurado');
          alert('âš ï¸ Configure os dados da viagem primeiro!\nClique em "ğŸš¢ Nova Viagem" para comeÃ§ar.');
          return;
        }

        // Marcar como processando
        isProcessingWaypoint = true;
        console.log('ğŸ”’ Flag de processamento ativada');
        console.log('   Timestamp:', Date.now());

        // NOVO v2.0.3: Timeout de seguranÃ§a (se demorar >2s, liberar automaticamente)
        processingTimeout = setTimeout(() => {
          console.warn('âš ï¸ TIMEOUT: Liberando flag apÃ³s 2 segundos');
          isProcessingWaypoint = false;
        }, 2000);

        // Criar waypoint
        try {
          console.log('ğŸ“ Criando waypoint em:', e.latlng.lat, e.latlng.lng);
          const beforeLength = waypoints.length;

          createWaypoint(e.latlng.lat, e.latlng.lng);

          const afterLength = waypoints.length;
          console.log('âœ… createWaypoint() retornou');
          console.log('   Waypoints antes:', beforeLength);
          console.log('   Waypoints depois:', afterLength);

          if (afterLength === beforeLength) {
            console.error('âŒ ERRO: createWaypoint nÃ£o adicionou waypoint!');
            console.error('   Array nÃ£o cresceu!');
          } else {
            console.log('âœ… Waypoint adicionado com sucesso! Array cresceu de', beforeLength, 'para', afterLength);
          }

        } catch (error) {
          console.error('âŒ EXCEÃ‡ÃƒO em createWaypoint:', error);
          console.error('   Stack:', error.stack);
          alert('ERRO ao criar waypoint: ' + error.message);
        }

        // Liberar flag apÃ³s pequeno delay
        setTimeout(() => {
          clearTimeout(processingTimeout);
          isProcessingWaypoint = false;
          console.log('ğŸ”“ Flag de processamento desativada');
          console.log('   Timestamp:', Date.now());
          console.log('   Waypoints atuais:', waypoints.length);
        }, 300);
      }

      // Adicionar listeners para click E tap (mobile)
      map.on('click', handleMapClick);
      map.on('tap', handleMapClick);  // EspecÃ­fico para mobile

      console.log('âœ… Event listeners do mapa configurados (click + tap)');

      updateWaypointsList();
      updateRouteInfo();
      updateFuelInfo();
      updateNearestLighthouses();
      updateStatus();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CORREÃ‡ÃƒO v2.0.2: ForÃ§ar renderizaÃ§Ã£o do mapa em mobile
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      console.log('ğŸ—ºï¸ Configurando renderizaÃ§Ã£o para mobile...');

      // ForÃ§ar redimensionamento apÃ³s inicializaÃ§Ã£o
      setTimeout(() => {
        map.invalidateSize();
        console.log('âœ… Mapa redimensionado (invalidateSize)');
      }, 250);

      // Listener para resize da janela (importante para mobile)
      window.addEventListener('resize', function () {
        console.log('ğŸ“ Janela redimensionada, ajustando mapa...');
        map.invalidateSize();
      });

      // Listener para mudanÃ§a de orientaÃ§Ã£o (rotation em mobile)
      window.addEventListener('orientationchange', function () {
        console.log('ğŸ”„ OrientaÃ§Ã£o mudou, ajustando mapa...');
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      });

      console.log('âœ… Listeners de renderizaÃ§Ã£o mobile configurados');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TOUR / ONBOARDING SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let currentTourStep = 0;
    const tourSteps = [
      {
        target: null, // Center
        title: "ğŸ‘‹ Bem-vindo ao Coastal Navigator",
        text: "Vamos fazer um tour rÃ¡pido pelas funcionalidades principais do sistema. O Coastal Navigator ajuda vocÃª a planejar rotas costeiras com precisÃ£o."
      },
      {
        target: ".btn-primary", // Nova Viagem button
        title: "ğŸš¢ Comece Aqui",
        text: "Clique em 'Nova Viagem' para configurar sua embarcaÃ§Ã£o, definir origem, destino e dados de combustÃ­vel. Isso habilita o cÃ¡lculo de ETA."
      },
      {
        target: null,
        targetHeaderBtn: "clearAll",
        title: "ğŸ—‘ï¸ Limpar Viagem",
        text: "Use este botÃ£o para resetar todos os mapas, waypoints e dados, comeÃ§ando uma rota do zero."
      },
      {
        target: null,
        targetHeaderBtn: "gpxFile",
        title: "ğŸ“ Importar GPX",
        text: "JÃ¡ tem uma rota salva? Importe arquivos GPX para visualizar waypoints e rotas instantaneamente."
      },
      {
        target: null,
        targetHeaderBtn: "exportGPX",
        title: "ğŸ’¾ Exportar Dados",
        text: "Salve o planejamento da sua viagem. A exportaÃ§Ã£o gera um arquivo GPX compatÃ­vel com a maioria dos GPS maritimos."
      },
      {
        target: "#map", // Map
        title: "ğŸ—ºï¸ Carta NÃ¡utica Interativa",
        text: "Este Ã© o seu mapa principal. Clique em qualquer lugar do oceano para adicionar Waypoints e traÃ§ar sua rota automaticamente."
      },
      {
        target: ".info-panel", // Wait, need a visible button? Let's target the Info button
        targetHeaderBtn: "toggleInfo", // Special handler selector
        title: "â„¹ï¸ Detalhes da Rota",
        text: "Use o botÃ£o 'Info' ou 'Gerar RelatÃ³rio' para ver a lista detalhada de waypoints, consumo trecho-a-trecho e saldo de combustÃ­vel."
      },
      {
        target: ".app-footer", // Footer
        title: "ğŸ“Š Monitoramento em Tempo Real",
        text: "A barra inferior mostra o resumo vital: DistÃ¢ncia total, ETA acumulado e status do tanque de combustÃ­vel. Fique de olho aqui!"
      }
    ];

    function startOnboardingTour() {
      currentTourStep = 0;
      document.getElementById('tourOverlay').classList.add('active');
      showTourStep();
    }

    function endTour() {
      document.getElementById('tourOverlay').classList.remove('active');
      document.getElementById('tourHighlight').style.display = 'none';
      document.getElementById('tourTooltip').style.display = 'none';
    }

    function showTourStep() {
      const step = tourSteps[currentTourStep];
      const highlight = document.getElementById('tourHighlight');
      const tooltip = document.getElementById('tourTooltip');

      // Update Content
      document.getElementById('tourTitle').innerHTML = step.title;
      document.getElementById('tourText').innerHTML = step.text;

      // Button States
      document.getElementById('tourPrevBtn').style.display = currentTourStep === 0 ? 'none' : 'block';
      document.getElementById('tourNextBtn').innerText = currentTourStep === tourSteps.length - 1 ? 'Concluir' : 'PrÃ³ximo';

      // Position logic
      if (step.target) {
        let el = document.querySelector(step.target);
        // Special handle for button check
        if (step.targetHeaderBtn) {
          // Find button with specific onclick
          const btns = document.querySelectorAll('.btn');
          btns.forEach(b => {
            if (b.getAttribute('onclick') && b.getAttribute('onclick').includes(step.targetHeaderBtn)) el = b;
          });
        }

        if (el) {
          const rect = el.getBoundingClientRect();

          // Show and Position Highlight
          highlight.style.display = 'block';
          highlight.style.width = (rect.width + 10) + 'px';
          highlight.style.height = (rect.height + 10) + 'px';
          highlight.style.top = (rect.top - 5) + 'px';
          highlight.style.left = (rect.left - 5) + 'px';

          // Position Tooltip
          tooltip.style.display = 'block';

          // Logic to auto-position tooltip (bottom, top, left, right)
          // Simple: Default bottom, check overflow
          let topPos = rect.bottom + 15;
          let leftPos = rect.left + (rect.width / 2) - 150; // Center horiz

          // If too low, put on top
          if (topPos + 200 > window.innerHeight) {
            topPos = rect.top - 220; // Move above
          }

          // Clamp Left
          if (leftPos < 10) leftPos = 10;
          const tooltipWidth = Math.min(300, window.innerWidth * 0.9); // 300 or 90% of screen
          if (leftPos + tooltipWidth > window.innerWidth) leftPos = window.innerWidth - tooltipWidth - 10;

          // Ensure width is set on element if clamped
          tooltip.style.transform = 'none'; // Clear center transform
          tooltip.style.width = tooltipWidth + 'px';
          tooltip.style.top = topPos + 'px';
          tooltip.style.left = leftPos + 'px';
          return;
        }
      }

      // If no target (Center Modal)
      highlight.style.display = 'none';
      tooltip.style.display = 'block';
      tooltip.style.top = '50%';
      tooltip.style.left = '50%';
      tooltip.style.transform = 'translate(-50%, -50%)';
    }

    function nextTourStep() {
      if (currentTourStep < tourSteps.length - 1) {
        currentTourStep++;
        showTourStep();
      } else {
        endTour();
      }
    }

    function prevTourStep() {
      if (currentTourStep > 0) {
        currentTourStep--;
        showTourStep();
      }
    }


    function showDebugInfo() {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ› DEBUG INFO - Estado Atual do Sistema');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('waypoints.length:', waypoints.length);
      console.log('waypointMarkers.length:', waypointMarkers.length);
      console.log('waypointCounter:', waypointCounter);
      console.log('tripData:', tripData);
      console.log('');
      console.log('Lista de waypoints:');
      waypoints.forEach((wp, i) => {
        console.log(`  ${i}: ${wp.name} (ID: ${wp.id})`);
      });
      console.log('');
      console.log('Lista de marcadores:');
      waypointMarkers.forEach((wm, i) => {
        console.log(`  ${i}: ID ${wm.id}`);
      });
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      let msg = 'ğŸ› DEBUG INFO\n\n';
      msg += `waypoints.length: ${waypoints.length}\n`;
      msg += `waypointMarkers.length: ${waypointMarkers.length}\n`;
      msg += `waypointCounter: ${waypointCounter}\n`;
      msg += `tripData: ${tripData ? 'Configurado' : 'NÃƒO configurado'}\n\n`;
      msg += 'Waypoints:\n';
      if (waypoints.length === 0) {
        msg += '  (nenhum)\n';
      } else {
        waypoints.forEach((wp, i) => {
          msg += `  ${i + 1}. ${wp.name}\n`;
        });
      }
      msg += '\n';
      msg += 'Marcadores no mapa:\n';
      msg += `  ${waypointMarkers.length} marcador(es)\n`;
      msg += '\n';
      msg += 'VERIFICAR:\n';
      if (waypoints.length !== waypointMarkers.length) {
        msg += '  âŒ ERRO: Contagem diferente!\n';
      } else {
        msg += '  âœ… Contagem consistente\n';
      }

      alert(msg);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GERENCIAMENTO DE MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function openTripModal() {
      document.getElementById('tripModal').classList.add('active');
      // Definir data/hora atual como padrÃ£o
      const now = new Date();
      const localDateTime = now.toISOString().slice(0, 16);
      document.getElementById('departureDate').value = localDateTime;
    }

    function closeTripModal() {
      document.getElementById('tripModal').classList.remove('active');
    }

    function saveTripData(event) {
      event.preventDefault();

      // Coletar dados do formulÃ¡rio
      tripData = {
        vesselName: document.getElementById('vesselName').value,
        origin: document.getElementById('origin').value,
        destination: document.getElementById('destination').value,
        departureDate: new Date(document.getElementById('departureDate').value),
        speedKnots: parseFloat(document.getElementById('speedKnots').value),
        fuelConsumption: parseFloat(document.getElementById('fuelConsumption').value),
        fuelInitial: parseFloat(document.getElementById('fuelInitial').value)
      };

      // Atualizar interface
      document.getElementById('infoVessel').textContent = tripData.vesselName;
      document.getElementById('infoOrigin').textContent = tripData.origin;
      document.getElementById('infoDestination').textContent = tripData.destination;
      document.getElementById('infoDeparture').textContent = tripData.departureDate.toLocaleString('pt-BR');
      document.getElementById('infoSpeed').textContent = tripData.speedKnots + ' kts';
      document.getElementById('tripInfoBar').classList.add('active');

      closeTripModal();
      alert('âœ… Viagem configurada!\n\nAgora vocÃª pode adicionar waypoints clicando no mapa.');

      console.log('Dados da viagem salvos:', tripData);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CRIAÃ‡ÃƒO DE WAYPOINTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /*
    FUNÃ‡ÃƒO: createWaypoint(lat, lng)
    
    Cria um novo waypoint na posiÃ§Ã£o especificada com:
    - CÃ¡lculo automÃ¡tico de distÃ¢ncia do waypoint anterior
    - CÃ¡lculo de ETA baseado na velocidade
    - CÃ¡lculo de consumo de combustÃ­vel
    - CriaÃ§Ã£o automÃ¡tica de rota
    - ValidaÃ§Ã£o de combustÃ­vel suficiente
    */
    function createWaypoint(lat, lng) {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ¯ createWaypoint() INICIADO');
      console.log('ğŸ“ Lat:', lat, 'Lng:', lng);
      console.log('ğŸ“Š Estado atual:');
      console.log('   - waypoints.length:', waypoints.length);
      console.log('   - waypointCounter:', waypointCounter);
      console.log('   - tripData:', tripData ? 'Configurado' : 'NÃƒO configurado');

      if (!tripData) {
        console.log('âŒ ABORTADO: tripData nÃ£o configurado');
        alert('âš ï¸ Configure os dados da viagem primeiro!');
        return;
      }

      console.log('âœ… tripData OK, criando objeto waypoint...');

      // Criar objeto waypoint
      const waypoint = {
        id: Date.now(),
        name: `WP${String(waypointCounter).padStart(3, '0')}`,
        lat: lat,
        lng: lng,
        distance: 0,
        totalDistance: 0,
        eta: null,
        timeFromPrevious: 0,
        fuelUsed: 0,
        fuelRemaining: tripData.fuelInitial,
        nearestLighthouse: null,
        lighthouseVisible: false
      };

      console.log('âœ… Objeto waypoint criado:', waypoint.name, 'ID:', waypoint.id);

      // Se nÃ£o Ã© o primeiro waypoint, calcular distÃ¢ncias e tempos
      if (waypoints.length > 0) {
        const prevWp = waypoints[waypoints.length - 1];

        // Calcular distÃ¢ncia atÃ© waypoint anterior
        waypoint.distance = calculateDistance(prevWp.lat, prevWp.lng, lat, lng);

        // Calcular distÃ¢ncia total acumulada
        waypoint.totalDistance = prevWp.totalDistance + waypoint.distance;

        // Calcular tempo de viagem atÃ© este waypoint (em horas)
        waypoint.timeFromPrevious = waypoint.distance / tripData.speedKnots;

        // Calcular ETA
        const timeOffset = waypoint.timeFromPrevious * 60 * 60 * 1000; // ms
        waypoint.eta = new Date(prevWp.eta ? prevWp.eta.getTime() + timeOffset : tripData.departureDate.getTime() + timeOffset);

        // Calcular consumo de combustÃ­vel
        waypoint.fuelUsed = prevWp.fuelUsed + (waypoint.timeFromPrevious * tripData.fuelConsumption);
        waypoint.fuelRemaining = tripData.fuelInitial - waypoint.fuelUsed;

        // Validar se hÃ¡ combustÃ­vel suficiente
        if (waypoint.fuelRemaining < 0) {
          alert(`âš ï¸ COMBUSTÃVEL INSUFICIENTE!\n\nO combustÃ­vel acabaria antes de chegar a ${waypoint.name}.\n\nCombustÃ­vel necessÃ¡rio: ${waypoint.fuelUsed.toFixed(0)} L\nCombustÃ­vel disponÃ­vel: ${tripData.fuelInitial.toFixed(0)} L\n\nDeficit: ${Math.abs(waypoint.fuelRemaining).toFixed(0)} L`);
          return;
        }
      } else {
        // Primeiro waypoint
        waypoint.eta = tripData.departureDate;
        waypoint.totalDistance = 0;
      }

      // Encontrar farol mais prÃ³ximo
      const nearest = findNearestLighthouse(lat, lng);
      waypoint.nearestLighthouse = nearest.lighthouse;
      const visibility = calculateVisibility(nearest.lighthouse.height);
      waypoint.lighthouseVisible = nearest.distance <= visibility;

      // Adicionar ao array
      console.log('â• ADICIONANDO ao array waypoints...');
      console.log('   waypoints.length ANTES:', waypoints.length);
      console.log('   Array atual:', waypoints.map(wp => wp.name));

      try {
        waypoints.push(waypoint);
        console.log('âœ… push() executado');
      } catch (error) {
        console.error('âŒ ERRO no push():', error);
        alert('ERRO ao adicionar waypoint: ' + error.message);
        return;
      }

      console.log('   waypoints.length DEPOIS:', waypoints.length);
      console.log('   Array atual:', waypoints.map(wp => wp.name));

      // VERIFICAÃ‡ÃƒO CRÃTICA: O waypoint foi realmente adicionado?
      if (waypoints.length === 0) {
        console.error('âŒ ERRO CRÃTICO: Array vazio apÃ³s push!');
        alert('ERRO: Array waypoints estÃ¡ vazio apÃ³s push!');
        return;
      }

      const lastWaypoint = waypoints[waypoints.length - 1];
      if (lastWaypoint.id !== waypoint.id) {
        console.error('âŒ ERRO CRÃTICO: Waypoint adicionado nÃ£o Ã© o Ãºltimo!');
        console.error('   Esperado ID:', waypoint.id);
        console.error('   Ãšltimo ID:', lastWaypoint.id);
        alert('ERRO: Waypoint nÃ£o foi adicionado corretamente!');
        return;
      }

      console.log('âœ… Waypoint verificado no array! ID:', lastWaypoint.id);

      console.log('ğŸ”¢ INCREMENTANDO waypointCounter...');
      console.log('   waypointCounter ANTES:', waypointCounter);
      waypointCounter++;
      console.log('   waypointCounter DEPOIS:', waypointCounter);

      // Criar marcador visual
      const marker = L.marker([lat, lng], {
        draggable: true,
        icon: L.divIcon({
          className: 'waypoint-custom-icon',
          html: `<div style="
            background: #1976D2;
            color: white;
            border: 2px solid #0A1929;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
          ">${waypointCounter - 1}</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        })
      }).addTo(map);

      // Popup com informaÃ§Ãµes
      marker.bindPopup(getWaypointPopupContent(waypoint));

      // Event listener para arrastar
      marker.on('dragend', function (e) {
        const newPos = e.target.getLatLng();
        updateWaypointPosition(waypoint.id, newPos.lat, newPos.lng);
      });

      // Event listener para clique (excluir)
      marker.on('contextmenu', function () {
        if (confirm(`Excluir ${waypoint.name}?`)) {
          deleteWaypoint(waypoint.id);
        }
      });

      waypointMarkers.push({
        id: waypoint.id,
        marker: marker
      });

      // Criar/atualizar rota automaticamente
      createRoute();

      // Atualizar interface
      updateWaypointsList();
      updateRouteInfo();
      updateFuelInfo();
      updateNearestLighthouses();
      updateStatus();

      // Mostrar botÃ£o de relatÃ³rio se houver waypoints
      if (waypoints.length >= 2) {
        document.getElementById('reportBtn').style.display = 'flex';
      }

      console.log('âœ… createWaypoint() CONCLUÃDO COM SUCESSO!');
      console.log('ğŸ“Š Estado final:');
      console.log('   - waypoints.length:', waypoints.length);
      console.log('   - waypointMarkers.length:', waypointMarkers.length);
      console.log('   - waypointCounter:', waypointCounter);
      console.log('   - Lista de waypoints:', waypoints.map(wp => wp.name));
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      // FEEDBACK VISUAL: Alert de sucesso
      const waypointName = waypoint.name;
      const totalWaypoints = waypoints.length;
      console.log(`ğŸ‰ SUCESSO: ${waypointName} criado! Total: ${totalWaypoints}`);

      // Opcional: VibraÃ§Ã£o em mobile (se suportado)
      if ('vibrate' in navigator) {
        navigator.vibrate(50);
      }
    }

    function getWaypointPopupContent(wp) {
      return `
        <div style="font-family: 'Rajdhani', sans-serif; min-width: 250px;">
          <strong style="color: #1976D2; font-size: 1.2rem;">ğŸ“ ${wp.name}</strong><br><br>
          <strong>PosiÃ§Ã£o:</strong> ${wp.lat.toFixed(6)}Â°, ${wp.lng.toFixed(6)}Â°<br>
          <strong>DistÃ¢ncia atÃ© aqui:</strong> ${wp.distance.toFixed(2)} NM<br>
          <strong>DistÃ¢ncia total:</strong> ${wp.totalDistance.toFixed(2)} NM<br>
          <strong>ETA:</strong> ${wp.eta ? wp.eta.toLocaleString('pt-BR') : 'Partida'}<br>
          <strong>Tempo de viagem:</strong> ${wp.timeFromPrevious > 0 ? (wp.timeFromPrevious).toFixed(1) + 'h' : '-'}<br>
          <strong>CombustÃ­vel usado:</strong> ${wp.fuelUsed.toFixed(0)} L<br>
          <strong>CombustÃ­vel restante:</strong> ${wp.fuelRemaining.toFixed(0)} L<br>
          <strong>Farol mais prÃ³ximo:</strong> ${wp.nearestLighthouse.name}<br>
          <strong>Visibilidade:</strong> ${wp.lighthouseVisible ? '<span style="color: #4CAF50;">âœ“ VisÃ­vel</span>' : '<span style="color: #FFA726;">âš  Fora de alcance</span>'}
        </div>
      `;
    }

    function updateWaypointPosition(id, newLat, newLng) {
      const index = waypoints.findIndex(wp => wp.id === id);
      if (index === -1) return;

      waypoints[index].lat = newLat;
      waypoints[index].lng = newLng;

      // Recalcular tudo a partir deste waypoint
      recalculateFromWaypoint(index);

      // Atualizar popup
      const marker = waypointMarkers.find(wm => wm.id === id);
      if (marker) {
        marker.marker.setPopupContent(getWaypointPopupContent(waypoints[index]));
      }

      createRoute();
      updateWaypointsList();
      updateRouteInfo();
      updateFuelInfo();
      updateNearestLighthouses();
      updateStatus();
    }

    function recalculateFromWaypoint(startIndex) {
      for (let i = startIndex; i < waypoints.length; i++) {
        const wp = waypoints[i];

        if (i > 0) {
          const prevWp = waypoints[i - 1];

          // Recalcular distÃ¢ncia
          wp.distance = calculateDistance(prevWp.lat, prevWp.lng, wp.lat, wp.lng);
          wp.totalDistance = prevWp.totalDistance + wp.distance;

          // Recalcular tempo
          wp.timeFromPrevious = wp.distance / tripData.speedKnots;
          const timeOffset = wp.timeFromPrevious * 60 * 60 * 1000;
          wp.eta = new Date(prevWp.eta.getTime() + timeOffset);

          // Recalcular combustÃ­vel
          wp.fuelUsed = prevWp.fuelUsed + (wp.timeFromPrevious * tripData.fuelConsumption);
          wp.fuelRemaining = tripData.fuelInitial - wp.fuelUsed;
        }

        // Recalcular farol mais prÃ³ximo
        const nearest = findNearestLighthouse(wp.lat, wp.lng);
        wp.nearestLighthouse = nearest.lighthouse;
        const visibility = calculateVisibility(nearest.lighthouse.height);
        wp.lighthouseVisible = nearest.distance <= visibility;
      }
    }

    function deleteWaypoint(id) {
      const index = waypoints.findIndex(wp => wp.id === id);
      if (index === -1) return;

      // Remover do array
      waypoints.splice(index, 1);

      // Remover marcador do mapa
      const markerIndex = waypointMarkers.findIndex(wm => wm.id === id);
      if (markerIndex !== -1) {
        map.removeLayer(waypointMarkers[markerIndex].marker);
        waypointMarkers.splice(markerIndex, 1);
      }

      // Recalcular a partir do waypoint anterior
      if (index > 0 && waypoints.length > index) {
        recalculateFromWaypoint(index);
      }

      // Atualizar rota
      createRoute();

      // Atualizar interface
      updateWaypointsList();
      updateRouteInfo();
      updateFuelInfo();
      updateNearestLighthouses();
      updateStatus();

      // Ocultar botÃ£o de relatÃ³rio se nÃ£o houver waypoints suficientes
      if (waypoints.length < 2) {
        document.getElementById('reportBtn').style.display = 'none';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CRIAÃ‡ÃƒO AUTOMÃTICA DE ROTA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function createRoute() {
      // Remover rota anterior se existir
      if (route) {
        map.removeLayer(route);
        route = null;
      }

      // Criar nova rota se houver 2+ waypoints
      if (waypoints.length >= 2) {
        const latLngs = waypoints.map(wp => [wp.lat, wp.lng]);

        route = L.polyline(latLngs, {
          color: '#FFA726',
          weight: 3,
          opacity: 0.8,
          smoothFactor: 1
        }).addTo(map);

        // CORREÃ‡ÃƒO v2.0.4: Removido route.setText() que causava erro
        // setText() requer plugin Leaflet.textPath que nÃ£o estÃ¡ carregado
        // Setas de direÃ§Ã£o sÃ£o decorativas e nÃ£o essenciais
        console.log('âœ… Rota criada com', waypoints.length, 'waypoints');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ALGORITMOS NÃUTICOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /*
    ALGORITMO: HAVERSINE - CÃ¡lculo de DistÃ¢ncia OrtodrÃ´mica
    
    FÃ³rmula que calcula distÃ¢ncia entre dois pontos na esfera terrestre.
    
    VARIÃVEIS:
    - lat1, lng1: Coordenadas do primeiro ponto (graus)
    - lat2, lng2: Coordenadas do segundo ponto (graus)
    - R: Raio da Terra em milhas nÃ¡uticas (3440.065 NM)
    
    COMPORTAMENTO:
    1. Converte graus para radianos
    2. Calcula diferenÃ§as de latitude e longitude
    3. Aplica fÃ³rmula haversine: a = sinÂ²(Î”lat/2) + cos(lat1) Ã— cos(lat2) Ã— sinÂ²(Î”lng/2)
    4. Calcula distÃ¢ncia angular: c = 2 Ã— atan2(âˆša, âˆš(1âˆ’a))
    5. Converte para distÃ¢ncia linear: d = R Ã— c
    
    COMPLEXIDADE: O(1) - tempo constante
    PRECISÃƒO: Â±0.5% para distÃ¢ncias < 1000 NM
    */
    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 3440.065; // Raio da Terra em milhas nÃ¡uticas
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;

      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c;

      return distance;
    }

    /*
    ALGORITMO: Visibilidade GeogrÃ¡fica de FarÃ³is
    
    Calcula alcance visual do farol baseado em altura focal.
    
    FÃ“RMULA: d = 2.08 Ã— (âˆšhâ‚ + âˆšhâ‚‚)
    Onde:
    - d = distÃ¢ncia em milhas nÃ¡uticas
    - hâ‚ = altura do farol em metros
    - hâ‚‚ = altura do observador (5m - ponte tÃ­pica)
    - 2.08 = constante que considera refraÃ§Ã£o atmosfÃ©rica
    
    COMPORTAMENTO:
    - Quanto maior o farol, maior o alcance visual
    - RelaÃ§Ã£o nÃ£o-linear (raiz quadrada)
    - Farol de 40m: ~15.8 NM de alcance
    - Farol de 60m: ~18.3 NM de alcance
    */
    function calculateVisibility(lighthouseHeight) {
      const observerHeight = 5; // Altura da ponte do rebocador (5 metros tÃ­pico)
      const visibility = 2.08 * (Math.sqrt(lighthouseHeight) + Math.sqrt(observerHeight));
      return visibility;
    }

    /*
    ALGORITMO: Busca de Farol Mais PrÃ³ximo
    
    Encontra o farol mais prÃ³ximo de uma posiÃ§Ã£o dada.
    
    MÃ‰TODO: Busca linear
    COMPLEXIDADE: O(n) onde n = 69 farÃ³is
    
    COMPORTAMENTO:
    1. Calcula distÃ¢ncia atÃ© todos os 69 farÃ³is
    2. Encontra o mÃ­nimo
    3. Retorna farol e distÃ¢ncia
    */
    function findNearestLighthouse(lat, lng) {
      let minDistance = Infinity;
      let nearest = null;

      lighthouses.forEach(lh => {
        const dist = calculateDistance(lat, lng, lh.lat, lh.lng);
        if (dist < minDistance) {
          minDistance = dist;
          nearest = lh;
        }
      });

      return {
        lighthouse: nearest,
        distance: minDistance
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // IMPORT/EXPORT GPX
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function importGPX(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!tripData) {
        alert('âš ï¸ Configure os dados da viagem antes de importar GPX!');
        return;
      }

      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ“¥ IMPORTANDO GPX:', file.name);
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      const reader = new FileReader();

      reader.onload = function (e) {
        const gpxText = e.target.result;
        console.log('âœ… Arquivo lido, tamanho:', gpxText.length, 'caracteres');

        const parser = new DOMParser();
        const gpxDoc = parser.parseFromString(gpxText, 'text/xml');

        // Verificar erros de parsing
        const parseError = gpxDoc.querySelector('parsererror');
        if (parseError) {
          console.error('âŒ ERRO ao parsear XML:', parseError.textContent);
          alert('âŒ Erro ao ler arquivo GPX!\nFormato invÃ¡lido.');
          return;
        }

        // Extrair pontos - suporta 3 formatos GPX
        // <wpt> = Waypoints (pontos individuais)
        // <rtept> = Route points (pontos de rota planejada)
        // <trkpt> = Track points (pontos de trilha gravada)
        const wpts = gpxDoc.getElementsByTagName('wpt');
        const rtepts = gpxDoc.getElementsByTagName('rtept');
        const trkpts = gpxDoc.getElementsByTagName('trkpt');

        console.log('ğŸ“ Pontos encontrados no GPX:');
        console.log('   - Waypoints (<wpt>):', wpts.length);
        console.log('   - Route points (<rtept>):', rtepts.length);
        console.log('   - Track points (<trkpt>):', trkpts.length);

        // Combinar todos os pontos em um Ãºnico array
        const allPoints = [...Array.from(wpts), ...Array.from(rtepts), ...Array.from(trkpts)];
        const totalPoints = allPoints.length;

        console.log('   - TOTAL de pontos:', totalPoints);

        if (totalPoints === 0) {
          alert('âš ï¸ Nenhum ponto encontrado no arquivo GPX!\n\nFormatos suportados:\nâ€¢ <wpt> (waypoints)\nâ€¢ <rtept> (route points)\nâ€¢ <trkpt> (track points)');
          return;
        }

        // Contar waypoints antes de importar
        const waypointsLengthBefore = waypoints.length;
        console.log('ğŸ“Š waypoints.length ANTES da importaÃ§Ã£o:', waypointsLengthBefore);

        let successCount = 0;
        let failCount = 0;

        allPoints.forEach((point, index) => {
          const lat = parseFloat(point.getAttribute('lat'));
          const lng = parseFloat(point.getAttribute('lon'));

          // Extrair nome do ponto (tag <n> ou <name>)
          const nameElement = point.querySelector('n') || point.querySelector('name');
          const pointName = nameElement ? nameElement.textContent : `Ponto ${index + 1}`;

          console.log(`   ${index + 1}/${totalPoints}: ${pointName} - lat=${lat}, lng=${lng}`);

          // Verificar se coordenadas sÃ£o vÃ¡lidas
          if (isNaN(lat) || isNaN(lng)) {
            console.error(`   âŒ Coordenadas invÃ¡lidas`);
            failCount++;
            return;
          }

          try {
            // Guardar quantidade antes
            const lengthBefore = waypoints.length;

            createWaypoint(lat, lng);

            // Verificar se waypoint foi adicionado
            const lengthAfter = waypoints.length;

            if (lengthAfter > lengthBefore) {
              console.log(`   âœ… Waypoint ${index + 1} (${pointName}) adicionado com sucesso`);
              successCount++;
            } else {
              console.error(`   âŒ Waypoint ${index + 1} (${pointName}) NÃƒO foi adicionado`);
              failCount++;
            }
          } catch (error) {
            console.error(`   âŒ Erro ao criar waypoint ${index + 1}:`, error);
            failCount++;
          }
        });

        const waypointsLengthAfter = waypoints.length;
        const actuallyAdded = waypointsLengthAfter - waypointsLengthBefore;

        console.log('');
        console.log('ğŸ“Š RESULTADO DA IMPORTAÃ‡ÃƒO:');
        console.log('   - Pontos no GPX:', totalPoints);
        console.log('   - Criados com sucesso:', successCount);
        console.log('   - Falharam:', failCount);
        console.log('   - waypoints.length ANTES:', waypointsLengthBefore);
        console.log('   - waypoints.length DEPOIS:', waypointsLengthAfter);
        console.log('   - Realmente adicionados:', actuallyAdded);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        if (actuallyAdded === 0) {
          alert(`âš ï¸ GPX importado mas NENHUM waypoint foi adicionado!\n\nPossÃ­veis causas:\nâ€¢ CombustÃ­vel insuficiente para a rota\nâ€¢ Coordenadas invÃ¡lidas\nâ€¢ Erro no formato do arquivo\n\nVerifique o console (F12) para mais detalhes.`);
        } else if (actuallyAdded < totalPoints) {
          alert(`âš ï¸ GPX parcialmente importado!\n\n${actuallyAdded} de ${totalPoints} waypoints adicionados.\n\n${failCount} waypoints falharam (possivelmente por combustÃ­vel insuficiente).`);
        } else {
          alert(`âœ… GPX importado com sucesso!\n\n${actuallyAdded} waypoints adicionados.`);
        }
      };

      reader.onerror = function () {
        console.error('âŒ Erro ao ler arquivo');
        alert('âŒ Erro ao ler arquivo GPX!');
      };

      reader.readAsText(file);

      // Reset input
      event.target.value = '';
    }

    function exportGPX() {
      if (waypoints.length === 0) {
        alert('âš ï¸ Adicione waypoints antes de exportar!');
        return;
      }

      let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n';
      gpx += '<gpx version="1.1" creator="Coastal Navigator Brasil v2.0">\n';

      // Metadata
      if (tripData) {
        gpx += '  <metadata>\n';
        gpx += `    <name>${tripData.vesselName} - ${tripData.origin} para ${tripData.destination}</name>\n`;
        gpx += `    <desc>Derrota planejada - ${waypoints.length} waypoints</desc>\n`;
        gpx += `    <time>${tripData.departureDate.toISOString()}</time>\n`;
        gpx += '  </metadata>\n';
      }

      // Waypoints
      waypoints.forEach(wp => {
        gpx += `  <wpt lat="${wp.lat}" lon="${wp.lng}">\n`;
        gpx += `    <name>${wp.name}</name>\n`;
        gpx += `    <desc>ETA: ${wp.eta.toLocaleString('pt-BR')}</desc>\n`;
        gpx += `  </wpt>\n`;
      });

      // Track (rota)
      if (waypoints.length >= 2) {
        gpx += '  <trk>\n';
        gpx += `    <name>Rota ${tripData ? tripData.vesselName : 'Costeira'}</name>\n`;
        gpx += '    <trkseg>\n';

        waypoints.forEach(wp => {
          gpx += `      <trkpt lat="${wp.lat}" lon="${wp.lng}">\n`;
          gpx += `        <time>${wp.eta.toISOString()}</time>\n`;
          gpx += `      </trkpt>\n`;
        });

        gpx += '    </trkseg>\n';
        gpx += '  </trk>\n';
      }

      gpx += '</gpx>';

      // Download
      const blob = new Blob([gpx], { type: 'application/gpx+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `rota-${tripData ? tripData.vesselName.replace(/\s/g, '-') : 'costeira'}.gpx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert('âœ… Arquivo GPX exportado com sucesso!');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ATUALIZAÃ‡ÃƒO DE INTERFACE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function updateWaypointsList() {
      const listElement = document.getElementById('waypoints-list');

      if (waypoints.length === 0) {
        listElement.innerHTML = '<p style="color: #888;">Nenhum waypoint adicionado. Clique no mapa para adicionar.</p>';
        return;
      }

      let html = '';

      waypoints.forEach(wp => {
        html += `
          <div class="waypoint-item" style="cursor: pointer;" onclick="map.setView([${wp.lat}, ${wp.lng}], 10)">
            <div class="item-name">${wp.name}</div>
            <div class="item-details">
              <strong>ETA:</strong> ${wp.eta ? wp.eta.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'Partida'}<br>
              <strong>DistÃ¢ncia:</strong> ${wp.distance.toFixed(1)} NM (Total: ${wp.totalDistance.toFixed(1)} NM)<br>
              <strong>CombustÃ­vel restante:</strong> ${wp.fuelRemaining.toFixed(0)} L<br>
              <strong>Farol:</strong> ${wp.nearestLighthouse.name}
              ${wp.lighthouseVisible ? '<br><span style="color: #4CAF50;">âœ“ VisÃ­vel</span>' : '<br><span style="color: #FFA726;">âš  Fora de alcance</span>'}
            </div>
          </div>
        `;
      });

      listElement.innerHTML = html;
    }

    function updateRouteInfo() {
      const infoElement = document.getElementById('route-info');

      if (!route || waypoints.length < 2) {
        infoElement.innerHTML = '<p style="color: #888;">Adicione 2+ waypoints para criar rota</p>';
        return;
      }

      const lastWp = waypoints[waypoints.length - 1];
      const totalTime = (lastWp.eta - tripData.departureDate) / (1000 * 60 * 60); // horas

      let html = `
        <div style="background: rgba(25, 118, 210, 0.1); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <strong>DistÃ¢ncia Total:</strong> ${lastWp.totalDistance.toFixed(2)} NM<br>
          <strong>Tempo Total:</strong> ${totalTime.toFixed(1)}h (${(totalTime / 24).toFixed(1)} dias)<br>
          <strong>Waypoints:</strong> ${waypoints.length}<br>
          <strong>ETA Final:</strong> ${lastWp.eta.toLocaleString('pt-BR')}
        </div>
        <div style="font-size: 0.85rem;">
      `;

      waypoints.forEach((wp, i) => {
        if (i > 0) {
          html += `
            <div style="margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
              ${waypoints[i - 1].name} â†’ ${wp.name}: ${wp.distance.toFixed(1)} NM (${wp.timeFromPrevious.toFixed(1)}h)
            </div>
          `;
        }
      });

      html += '</div>';
      infoElement.innerHTML = html;
    }

    function updateFuelInfo() {
      const infoElement = document.getElementById('fuel-info');

      if (!tripData) {
        infoElement.innerHTML = '<p style="color: #888;">Configure a viagem para ver consumo</p>';
        return;
      }

      if (waypoints.length === 0) {
        infoElement.innerHTML = `
          <div style="background: rgba(76, 175, 80, 0.1); padding: 12px; border-radius: 6px;">
            <strong>Saldo Inicial:</strong> ${tripData.fuelInitial.toFixed(0)} L<br>
            <strong>Consumo:</strong> ${tripData.fuelConsumption.toFixed(1)} L/h<br>
            <strong>Status:</strong> <span style="color: #4CAF50;">Pronto para partida</span>
          </div>
        `;
        return;
      }

      const lastWp = waypoints[waypoints.length - 1];
      const fuelPercentage = (lastWp.fuelRemaining / tripData.fuelInitial) * 100;
      const totalTime = (lastWp.eta - tripData.departureDate) / (1000 * 60 * 60);

      let statusColor = '#4CAF50';
      let statusText = 'Normal';
      if (fuelPercentage < 20) {
        statusColor = '#D32F2F';
        statusText = 'CRÃTICO';
      } else if (fuelPercentage < 40) {
        statusColor = '#FFA726';
        statusText = 'AtenÃ§Ã£o';
      }

      let html = `
        <div style="background: rgba(${fuelPercentage < 40 ? '255, 167, 38' : '76, 175, 80'}, 0.1); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <strong>Saldo Inicial:</strong> ${tripData.fuelInitial.toFixed(0)} L<br>
          <strong>Consumo Total:</strong> ${lastWp.fuelUsed.toFixed(0)} L<br>
          <strong>Saldo Final:</strong> ${lastWp.fuelRemaining.toFixed(0)} L (${fuelPercentage.toFixed(1)}%)<br>
          <strong>Consumo L/dia:</strong> ${((lastWp.fuelUsed / (totalTime / 24))).toFixed(0)} L/dia<br>
          <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: 700;">${statusText}</span>
        </div>
        <div style="font-size: 0.85rem;">
          <strong>Consumo por PerÃ­odo de 12h:</strong><br>
      `;

      // Calcular consumo a cada 12 horas com data/hora real
      let time12h = 0;
      let prevFuel = 0;
      let periodNum = 1;

      waypoints.forEach((wp, i) => {
        const wpTime = (wp.eta - tripData.departureDate) / (1000 * 60 * 60);

        while (time12h + 12 <= wpTime) {
          time12h += 12;
          const fuelAt12h = time12h * tripData.fuelConsumption;
          const fuel12hPeriod = fuelAt12h - prevFuel;

          // NOVO v2.0.5: Calcular data/hora real do perÃ­odo
          const startDate = new Date(tripData.departureDate.getTime() + ((time12h - 12) * 60 * 60 * 1000));
          const endDate = new Date(tripData.departureDate.getTime() + (time12h * 60 * 60 * 1000));

          // Formatar data/hora compacto
          const formatDateTime = (date) => {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month} ${hour}:${minute}`;
          };

          html += `
            <div style="margin: 6px 0; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 4px;">
              PerÃ­odo ${periodNum}: ${formatDateTime(startDate)} - ${formatDateTime(endDate)}<br>
              Consumo: ${fuel12hPeriod.toFixed(0)} L | Acumulado: ${fuelAt12h.toFixed(0)} L
            </div>
          `;

          prevFuel = fuelAt12h;
          periodNum++;
        }
      });

      html += '</div>';
      infoElement.innerHTML = html;
    }

    function updateNearestLighthouses() {
      const listElement = document.getElementById('lighthouses-list');

      if (waypoints.length === 0) {
        listElement.innerHTML = '<p style="color: #888;">Adicione waypoints para ver farÃ³is prÃ³ximos</p>';
        return;
      }

      // Coletar farÃ³is Ãºnicos prÃ³ximos
      const nearbyLighthouses = new Set();

      waypoints.forEach(wp => {
        if (wp.nearestLighthouse) {
          const dist = calculateDistance(wp.lat, wp.lng, wp.nearestLighthouse.lat, wp.nearestLighthouse.lng);
          if (dist <= 50) {
            nearbyLighthouses.add(JSON.stringify({
              lighthouse: wp.nearestLighthouse,
              distance: dist
            }));
          }
        }
      });

      if (nearbyLighthouses.size === 0) {
        listElement.innerHTML = '<p style="color: #888;">Nenhum farol prÃ³ximo (raio 50 NM)</p>';
        return;
      }

      const lighthousesArray = Array.from(nearbyLighthouses).map(item => JSON.parse(item));
      lighthousesArray.sort((a, b) => a.distance - b.distance);

      let html = '';

      lighthousesArray.forEach(item => {
        const lh = item.lighthouse;
        const distance = item.distance;
        const visibility = calculateVisibility(lh.height);

        html += `
          <div class="lighthouse-item" style="cursor: pointer;" onclick="map.setView([${lh.lat}, ${lh.lng}], 12)">
            <div class="item-name">ğŸ’¡ ${lh.name}</div>
            <div class="item-details">
              <strong>DistÃ¢ncia:</strong> ${distance.toFixed(2)} NM<br>
              <strong>Alcance:</strong> ${lh.range} NM<br>
              <strong>Visibilidade:</strong> ${visibility.toFixed(2)} NM<br>
              <strong>CaracterÃ­stica:</strong> ${lh.character}
            </div>
          </div>
        `;
      });

      listElement.innerHTML = html;
    }

    function updateStatus() {
      document.getElementById('waypoint-count').textContent = waypoints.length;

      if (waypoints.length >= 2 && tripData) {
        const lastWp = waypoints[waypoints.length - 1];
        const totalTime = (lastWp.eta - tripData.departureDate) / (1000 * 60 * 60);

        document.getElementById('total-distance').textContent = lastWp.totalDistance.toFixed(1) + ' NM';
        document.getElementById('total-time').textContent = totalTime.toFixed(1) + 'h';
        document.getElementById('fuel-remaining').textContent = lastWp.fuelRemaining.toFixed(0) + ' L';

        // Mudar cor se combustÃ­vel crÃ­tico
        const fuelElement = document.getElementById('fuel-remaining');
        const fuelPercentage = (lastWp.fuelRemaining / tripData.fuelInitial) * 100;

        if (fuelPercentage < 20) {
          fuelElement.className = 'status-value status-warning';
        } else if (fuelPercentage < 40) {
          fuelElement.className = 'status-value';
          fuelElement.style.color = '#FFA726';
        } else {
          fuelElement.className = 'status-value status-success';
        }
      } else {
        document.getElementById('total-distance').textContent = '0 NM';
        document.getElementById('total-time').textContent = '0h';
        document.getElementById('fuel-remaining').textContent = tripData ? tripData.fuelInitial.toFixed(0) + ' L' : '0 L';
      }
    }

    function toggleInfo() {
      const panel = document.getElementById('infoPanel');
      panel.classList.toggle('active');
    }

    function clearAll() {
      if (!confirm('âš ï¸ Deseja realmente limpar toda a derrota?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
        return;
      }

      // Remover marcadores
      waypointMarkers.forEach(wm => {
        map.removeLayer(wm.marker);
      });

      // Remover rota
      if (route) {
        map.removeLayer(route);
        route = null;
      }

      // Limpar arrays
      waypoints = [];
      waypointMarkers = [];
      waypointCounter = 1;

      // Atualizar interface
      updateWaypointsList();
      updateRouteInfo();
      updateFuelInfo();
      updateNearestLighthouses();
      updateStatus();

      document.getElementById('reportBtn').style.display = 'none';

      alert('âœ… Derrota limpa!\n\nPronto para novo planejamento.');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GERAÃ‡ÃƒO DE RELATÃ“RIO HTML
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function generateReport() {
      if (waypoints.length < 2) {
        alert('âš ï¸ Adicione pelo menos 2 waypoints para gerar relatÃ³rio!');
        return;
      }

      const lastWp = waypoints[waypoints.length - 1];
      const totalTime = (lastWp.eta - tripData.departureDate) / (1000 * 60 * 60);
      const fuelPercentage = (lastWp.fuelRemaining / tripData.fuelInitial) * 100;

      let report = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RelatÃ³rio de Viagem - ${tripData.vesselName}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    .header {
      text-align: center;
      border-bottom: 3px solid #1976D2;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: #1976D2;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .header .subtitle {
      color: #666;
      font-size: 1.1rem;
    }
    
    .section {
      margin-bottom: 30px;
    }
    
    .section-title {
      background: #1976D2;
      color: white;
      padding: 10px 15px;
      font-size: 1.2rem;
      margin-bottom: 15px;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .info-item {
      border-left: 3px solid #FFA726;
      padding-left: 12px;
    }
    
    .info-label {
      font-weight: 600;
      color: #666;
      font-size: 0.9rem;
    }
    
    .info-value {
      font-size: 1.1rem;
      color: #1976D2;
      font-weight: 700;
      margin-top: 4px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    th {
      background: #1976D2;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }
    
    td {
      padding: 10px 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    tr:hover {
      background: #f5f5f5;
    }
    
    .status-ok {
      color: #4CAF50;
      font-weight: 700;
    }
    
    .status-warning {
      color: #FFA726;
      font-weight: 700;
    }
    
    .status-critical {
      color: #D32F2F;
      font-weight: 700;
    }
    
    .summary-box {
      background: linear-gradient(135deg, #1976D2, #0D47A1);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .summary-box h3 {
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .summary-item:last-child {
      border-bottom: none;
    }
    
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .container {
        box-shadow: none;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>âš“ RELATÃ“RIO DE PLANEJAMENTO DE VIAGEM</h1>
      <div class="subtitle">Coastal Navigator Brasil v2.0</div>
      <div class="subtitle">Gerado em: ${new Date().toLocaleString('pt-BR')}</div>
    </div>
    
    <div class="section">
      <div class="section-title">ğŸš¢ DADOS DA EMBARCAÃ‡ÃƒO E VIAGEM</div>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Nome da EmbarcaÃ§Ã£o</div>
          <div class="info-value">${tripData.vesselName}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Velocidade MÃ©dia</div>
          <div class="info-value">${tripData.speedKnots.toFixed(1)} nÃ³s</div>
        </div>
        <div class="info-item">
          <div class="info-label">Porto de Origem</div>
          <div class="info-value">${tripData.origin}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Porto de Destino</div>
          <div class="info-value">${tripData.destination}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Data/Hora de SaÃ­da</div>
          <div class="info-value">${tripData.departureDate.toLocaleString('pt-BR')}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ETA de Chegada</div>
          <div class="info-value">${lastWp.eta.toLocaleString('pt-BR')}</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="summary-box">
        <h3>ğŸ“Š RESUMO EXECUTIVO</h3>
        <div class="summary-item">
          <span>DistÃ¢ncia Total:</span>
          <strong>${lastWp.totalDistance.toFixed(2)} NM</strong>
        </div>
        <div class="summary-item">
          <span>Tempo Total de Viagem:</span>
          <strong>${totalTime.toFixed(1)} horas (${(totalTime / 24).toFixed(1)} dias)</strong>
        </div>
        <div class="summary-item">
          <span>NÃºmero de Waypoints:</span>
          <strong>${waypoints.length}</strong>
        </div>
        <div class="summary-item">
          <span>Consumo Total de CombustÃ­vel:</span>
          <strong>${lastWp.fuelUsed.toFixed(0)} L</strong>
        </div>
        <div class="summary-item">
          <span>Saldo Inicial de CombustÃ­vel:</span>
          <strong>${tripData.fuelInitial.toFixed(0)} L</strong>
        </div>
        <div class="summary-item">
          <span>Saldo Final de CombustÃ­vel:</span>
          <strong>${lastWp.fuelRemaining.toFixed(0)} L (${fuelPercentage.toFixed(1)}%)</strong>
        </div>
        <div class="summary-item">
          <span>Consumo MÃ©dio por Dia:</span>
          <strong>${((lastWp.fuelUsed / (totalTime / 24))).toFixed(0)} L/dia</strong>
        </div>
        <div class="summary-item">
          <span>Taxa de Consumo:</span>
          <strong>${tripData.fuelConsumption.toFixed(1)} L/h</strong>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">ğŸ“ LISTA DETALHADA DE WAYPOINTS</div>
      <table>
        <thead>
          <tr>
            <th>WP</th>
            <th>PosiÃ§Ã£o</th>
            <th>Data/Hora</th>
            <th>DistÃ¢ncia (NM)</th>
            <th>Farol VisÃ­vel</th>
            <th>CombustÃ­vel Acum. (L)</th>
            <th>Saldo (L)</th>
          </tr>
        </thead>
        <tbody>`;

      waypoints.forEach((wp, i) => {
        report += `
          <tr>
            <td><strong>${wp.name}</strong></td>
            <td>${wp.lat.toFixed(6)}Â°, ${wp.lng.toFixed(6)}Â°</td>
            <td>${wp.eta.toLocaleString('pt-BR')}</td>
            <td>${wp.distance.toFixed(2)} NM${i > 0 ? ` (Total: ${wp.totalDistance.toFixed(2)})` : ''}</td>
            <td class="${wp.lighthouseVisible ? 'status-ok' : 'status-warning'}">
              ${wp.lighthouseVisible ? 'âœ“ ' + wp.nearestLighthouse.name : 'âš  Fora de alcance'}
            </td>
            <td>${wp.fuelUsed.toFixed(0)} L</td>
            <td class="${wp.fuelRemaining / tripData.fuelInitial < 0.2 ? 'status-critical' : wp.fuelRemaining / tripData.fuelInitial < 0.4 ? 'status-warning' : 'status-ok'}">
              ${wp.fuelRemaining.toFixed(0)} L (${((wp.fuelRemaining / tripData.fuelInitial) * 100).toFixed(1)}%)
            </td>
          </tr>`;
      });

      report += `
        </tbody>
      </table>
    </div>
    
    <div class="section">
      <div class="section-title">â›½ CONSUMO POR PERÃODO DE 12 HORAS</div>
      <table>
        <thead>
          <tr>
            <th>PerÃ­odo</th>
            <th>Data/Hora</th>
            <th>Consumo (L)</th>
            <th>Acumulado (L)</th>
          </tr>
        </thead>
        <tbody>`;

      // Calcular consumo a cada 12 horas com data/hora real
      let time12h = 0;
      let prevFuel = 0;
      let periodNum = 1;

      while (time12h < totalTime) {
        const nextTime = Math.min(time12h + 12, totalTime);
        const periodDuration = nextTime - time12h;
        const fuelAtEnd = nextTime * tripData.fuelConsumption;
        const periodFuel = fuelAtEnd - prevFuel;

        // NOVO v2.0.5: Calcular data/hora real do perÃ­odo
        const startDate = new Date(tripData.departureDate.getTime() + (time12h * 60 * 60 * 1000));
        const endDate = new Date(tripData.departureDate.getTime() + (nextTime * 60 * 60 * 1000));

        // Formatar data/hora (formato compacto: dd/MM HH:mm)
        const formatDateTime = (date) => {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const hour = String(date.getHours()).padStart(2, '0');
          const minute = String(date.getMinutes()).padStart(2, '0');
          return `${day}/${month} ${hour}:${minute}`;
        };

        report += `
          <tr>
            <td><strong>PerÃ­odo ${periodNum}</strong></td>
            <td>${formatDateTime(startDate)} - ${formatDateTime(endDate)} (${periodDuration.toFixed(1)}h)</td>
            <td>${periodFuel.toFixed(0)} L</td>
            <td>${fuelAtEnd.toFixed(0)} L</td>
          </tr>`;

        time12h = nextTime;
        prevFuel = fuelAtEnd;
        periodNum++;
      }

      report += `
        </tbody>
      </table>
    </div>
    
    <div class="section">
      <div class="section-title">ğŸ’¡ FARÃ“IS DE REFERÃŠNCIA NA ROTA</div>
      <table>
        <thead>
          <tr>
            <th>Farol</th>
            <th>Waypoint PrÃ³ximo</th>
            <th>PosiÃ§Ã£o</th>
            <th>Alcance</th>
            <th>CaracterÃ­stica</th>
          </tr>
        </thead>
        <tbody>`;

      // Listar farÃ³is Ãºnicos referenciados
      const uniqueLighthouses = new Map();
      waypoints.forEach(wp => {
        if (wp.nearestLighthouse && !uniqueLighthouses.has(wp.nearestLighthouse.name)) {
          uniqueLighthouses.set(wp.nearestLighthouse.name, {
            lighthouse: wp.nearestLighthouse,
            waypoint: wp.name
          });
        }
      });

      uniqueLighthouses.forEach(item => {
        const lh = item.lighthouse;
        report += `
          <tr>
            <td><strong>${lh.name}</strong></td>
            <td>${item.waypoint}</td>
            <td>${lh.lat.toFixed(4)}Â°, ${lh.lng.toFixed(4)}Â°</td>
            <td>${lh.range} NM (Vis: ${calculateVisibility(lh.height).toFixed(1)} NM)</td>
            <td>${lh.character}</td>
          </tr>`;
      });

      report += `
        </tbody>
      </table>
    </div>
    
    <div class="section">
      <div class="section-title">âš ï¸ OBSERVAÃ‡Ã•ES E RECOMENDAÃ‡Ã•ES</div>
      <div style="padding: 15px; background: #f5f5f5; border-left: 4px solid #FFA726;">`;

      if (fuelPercentage < 20) {
        report += `
        <p style="color: #D32F2F; font-weight: 700; margin-bottom: 10px;">
          âš ï¸ ATENÃ‡ÃƒO: Margem de combustÃ­vel crÃ­tica (${fuelPercentage.toFixed(1)}%)
        </p>
        <p style="margin-bottom: 10px;">
          Recomenda-se reabastecimento antes da partida ou revisÃ£o da rota.
        </p>`;
      } else if (fuelPercentage < 40) {
        report += `
        <p style="color: #FFA726; font-weight: 700; margin-bottom: 10px;">
          âš ï¸ AtenÃ§Ã£o: Margem de combustÃ­vel moderada (${fuelPercentage.toFixed(1)}%)
        </p>
        <p style="margin-bottom: 10px;">
          Considere possÃ­veis desvios de rota ou condiÃ§Ãµes adversas.
        </p>`;
      } else {
        report += `
        <p style="color: #4CAF50; font-weight: 700; margin-bottom: 10px;">
          âœ“ Margem de combustÃ­vel adequada (${fuelPercentage.toFixed(1)}%)
        </p>`;
      }

      report += `
        <p style="margin-bottom: 10px;">
          â€¢ Verificar condiÃ§Ãµes meteorolÃ³gicas antes da partida<br>
          â€¢ Confirmar NOTMARs e Avisos aos Navegantes<br>
          â€¢ Validar posiÃ§Ãµes com cartas nÃ¡uticas oficiais da DHN<br>
          â€¢ Manter escuta no VHF canal 16 (emergÃªncias)<br>
          â€¢ Ajustar velocidade conforme condiÃ§Ãµes de mar e vento
        </p>
        <p style="font-size: 0.9rem; color: #666; margin-top: 15px;">
          <strong>AVISO LEGAL:</strong> Este relatÃ³rio Ã© uma ferramenta de planejamento. 
          NÃ£o substitui as cartas nÃ¡uticas oficiais, publicaÃ§Ãµes e julgamento profissional do Comandante.
          Sempre consulte as publicaÃ§Ãµes atualizadas da DHN antes de executar qualquer navegaÃ§Ã£o.
        </p>
      </div>
    </div>
    
    <div class="footer">
      <p><strong>Gerado por Coastal Navigator Brasil v2.0</strong></p>
      <p>Sistema de Planejamento de Viagem MarÃ­tima</p>
      <p>Desenvolvido por Jossian Brito (Charlie Bravo)</p>
      <p style="margin-top: 10px;">Â© 2024 - Todos os direitos reservados</p>
    </div>
  </div>
</body>
</html>`;

      // Criar e baixar arquivo
      const blob = new Blob([report], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `relatorio-viagem-${tripData.vesselName.replace(/\s/g, '-')}-${new Date().toISOString().slice(0, 10)}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert('âœ… RelatÃ³rio HTML gerado com sucesso!\n\nO arquivo foi baixado e pode ser aberto em qualquer navegador ou impresso.');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INICIALIZAÃ‡ÃƒO QUANDO PÃGINA CARREGA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    document.addEventListener('DOMContentLoaded', function () {
      initMap();
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('  Coastal Navigator Brasil v2.0.9 - Inicializado âš“');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('Autor: Jossian Brito (Charlie Bravo)');
      console.log('58 FarÃ³is curados carregados ğŸ’¡ (52 DHN + 6 Validados)');
      console.log('Sistema completo de planejamento de viagem ativo ğŸš¢');
      console.log('');
      console.log('CORREÃ‡Ã•ES v2.0.9:');
      console.log('âœ“ SÃ£o TomÃ© corrigido (RJ, nÃ£o AmazÃ´nia!)');
      console.log('âœ“ SimÃ£o Grande adicionado (ParÃ¡)');
      console.log('âœ“ 5 farÃ³is duplicados removidos');
      console.log('âœ“ Erro de 2100 km corrigido');
      console.log('âœ“ 58 farÃ³is 100% validados');
      console.log('');
      console.log('ğŸ“± MOBILE: Toque no mapa para adicionar waypoints');
      console.log('ğŸ–±ï¸ DESKTOP: Clique no mapa para adicionar waypoints');
      console.log('ğŸ› DEBUG: BotÃ£o "ğŸ› DEBUG" disponÃ­vel para diagnÃ³stico');
      console.log('ğŸ“¥ GPX: Suporta <wpt>, <rtept> e <trkpt>');
      console.log('ğŸ’¡ FARÃ“IS: Base oficial DHN + oceÃ¢nicos validados');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    });
  </script>
</body>

</html>